<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quote Tool - BAS Project Estimator</title>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            /* BAS Professional Color Palette */
            --primary-color: #0066cc;
            --secondary-color: #2C3E50;
            --accent-color: #3498DB;
            --success-color: #27AE60;
            --warning-color: #F39C12;
            --error-color: #E74C3C;
            --background-color: #F7F9FB;
            --surface-color: #FFFFFF;
            --text-primary: #2C3E50;
            --text-secondary: #6C757D;
            --text-muted: #95A5A6;
            --border-color: #E1E8ED;
            --shadow-light: 0 2px 4px rgba(44, 62, 80, 0.08);
            --shadow-medium: 0 4px 12px rgba(44, 62, 80, 0.12);
            --shadow-heavy: 0 8px 25px rgba(44, 62, 80, 0.15);
            --radius-small: 6px;
            --radius-medium: 8px;
            --radius-large: 12px;
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', sans-serif;
            background: var(--background-color);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            overflow: hidden;
            font-weight: 400;
        }

        .app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--primary-color);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-medium);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-img {
            height: 32px;
            width: auto;
            filter: brightness(0) invert(1);
            opacity: 0.95;
        }

        .header-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            font-size: 12px;
            opacity: 0.9;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .nav-button {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-small);
            color: white;
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            transition: var(--transition);
            cursor: pointer;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .nav-button.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
            font-weight: 600;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .toolbar {
            background: var(--surface-color);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            box-shadow: var(--shadow-light);
        }

        .btn {
            padding: 10px 16px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-radius: var(--radius-small);
            color: var(--text-primary);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--background-color);
            border-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }

        .btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            box-shadow: var(--shadow-light);
        }

        .btn.primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: 600;
        }

        .btn.primary:hover {
            background: #094046;
            border-color: #094046;
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: var(--surface-color);
            border-right: 1px solid var(--border-color);
            padding: 24px;
            overflow-y: auto;
            box-shadow: var(--shadow-light);
        }

        .content {
            flex: 1;
            background: var(--background-color);
            overflow-y: auto;
        }

        /* Tab System */
        .tab-container {
            margin: 16px;
        }

        .tab-nav {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: rgba(11, 76, 95, 0.05);
        }

        .tab-btn:hover:not(.active) {
            color: var(--text-primary);
            background: var(--background-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Templates Report */
        .templates-report {
            padding: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .summary-stats {
            display: flex;
            gap: 40px;
            margin-top: 15px;
        }

        .stat {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
        }

        .template-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e9ecef;
        }

        .template-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .template-count {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        .device-item {
            background: #f8f9fa;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            border-left: 3px solid #3498db;
            cursor: help;
        }

        .points-summary {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
            font-size: 12px;
            color: #6c757d;
        }

        .points-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .expand-points-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--accent-color);
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            transition: var(--transition);
        }

        .expand-points-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        .points-expanded {
            margin-top: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 4px;
        }

        .template-point-item {
            padding: 4px 8px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: var(--transition);
        }

        .template-point-item:hover {
            background: var(--accent-color);
            color: white;
        }

        /* Template Configuration Controls */
        .template-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin: 12px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .template-control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* Exclude container styles */
        .excluded-container {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .container-exclude-section {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .container-exclude-header {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .container-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .container-item:last-child {
            border-bottom: none;
        }

        .container-name {
            font-size: 13px;
            color: var(--text-primary);
            font-family: monospace;
        }

        .exclude-toggle-btn {
            padding: 2px 8px;
            font-size: 11px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            color: #666;
            transition: all 0.2s ease;
        }

        .exclude-toggle-btn:hover {
            background: #f5f5f5;
        }

        .exclude-toggle-btn.excluded {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        /* Drill-down exclude interface styles */
        .exclude-header {
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 6px 6px 0 0;
            padding: 8px;
        }

        .exclude-data-selector {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }

        .data-selector-btn {
            padding: 4px 12px;
            font-size: 11px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            color: #666;
        }

        .data-selector-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .exclude-breadcrumb {
            font-size: 11px;
            color: #666;
        }

        .breadcrumb-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            padding: 2px 4px;
            text-decoration: underline;
        }

        .breadcrumb-btn:hover {
            color: #0056b3;
        }

        .breadcrumb-separator {
            margin: 0 4px;
            color: #999;
        }

        .exclude-content {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 6px 6px;
            background: white;
        }

        .exclude-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }

        .exclude-item:last-child {
            border-bottom: none;
        }

        .exclude-item:hover {
            background: #f8f9fa;
        }

        .exclude-item.back-item {
            background: #f0f0f0;
            font-weight: 500;
        }

        .exclude-item-content {
            flex: 1;
        }

        .navigate-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            padding: 0;
            font-size: 12px;
            text-align: left;
        }

        .navigate-btn:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        .back-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0;
            font-size: 12px;
            font-weight: 500;
        }

        .back-btn:hover {
            color: #333;
        }

        .device-name {
            color: #333;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        /* Legacy grouped container display styles (kept for compatibility) */
        .container-group {
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
        }

        .container-group .container-item {
            background: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            font-weight: 500;
        }

        .equipment-list {
            padding: 4px 0;
        }

        .equipment-list.container-excluded {
            opacity: 0.5;
            background: #f5f5f5;
        }

        .equipment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 12px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }

        .equipment-item:last-child {
            border-bottom: none;
        }

        .equipment-name {
            flex: 1;
            color: #666;
        }

        .exclude-toggle-btn.equipment-btn {
            font-size: 10px;
            padding: 1px 6px;
            margin-left: 8px;
        }

        .exclude-toggle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #e9ecef;
            color: #6c757d;
        }

        .template-control-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .template-name-input {
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }

        .template-type-select {
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }

        .template-hours-input {
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            background: white;
            width: 80px;
        }

        .template-description {
            grid-column: 1 / -1;
            margin-top: 8px;
        }

        .template-description textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .export-quote-section {
            margin-top: 16px;
            text-align: center;
        }

        .quote-export {
            background: var(--success-color) !important;
            border-color: var(--success-color) !important;
            padding: 12px 24px;
            font-size: 14px;
        }

        .quote-export:hover {
            background: #219a52 !important;
            border-color: #219a52 !important;
        }

        /* Custom Template Creation */
        .custom-template-section {
            background: var(--surface-color);
            border: 2px solid var(--success-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
        }

        .custom-template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .custom-template-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--success-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .custom-template-toggle {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-small);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: var(--transition);
        }

        .custom-template-toggle:hover {
            background: #219a52;
            transform: translateY(-1px);
        }

        .custom-template-form {
            display: none;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 12px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-top: 12px;
        }

        .custom-template-form.show {
            display: grid;
        }

        .custom-template-form .template-description {
            grid-column: 1 / -1;
            margin-top: 8px;
        }

        .custom-template-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .custom-template-card {
            background: white;
            border: 2px solid var(--success-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
        }

        .custom-template-badge {
            position: absolute;
            top: -8px;
            right: 12px;
            background: var(--success-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .custom-template-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--error-color);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .custom-template-delete:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        /* Change Order Styles */
        .change-order-container {
            padding: 20px;
        }

        .change-order-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border-radius: var(--radius-medium);
        }

        .change-order-header h2 {
            margin-bottom: 8px;
            font-size: 24px;
        }

        .change-order-steps {
            max-width: 800px;
            margin: 0 auto;
        }

        .change-order-step {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-medium);
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
            overflow: hidden;
        }

        .change-order-step.active {
            border-color: var(--warning-color);
        }

        .step-header {
            background: var(--background-color);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: var(--warning-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .step-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        .step-content {
            padding: 20px;
        }

        .file-upload-section {
            text-align: center;
            padding: 20px;
        }

        .file-status {
            margin-top: 12px;
            padding: 12px;
            background: var(--background-color);
            border-radius: var(--radius-small);
            border: 1px solid var(--border-color);
        }

        .file-name {
            font-weight: 600;
            color: var(--text-primary);
            display: block;
            margin-bottom: 4px;
        }

        .file-stats {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .comparison-summary {
            background: var(--background-color);
            border-radius: var(--radius-medium);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .comparison-summary h4 {
            margin-bottom: 12px;
            color: var(--warning-color);
            font-size: 16px;
        }

        .comparison-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .comparison-stat {
            text-align: center;
            padding: 12px;
            background: var(--surface-color);
            border-radius: var(--radius-small);
            border: 1px solid var(--border-color);
        }

        .comparison-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--warning-color);
            margin-bottom: 4px;
        }

        .comparison-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .new-equipment-card {
            background: white;
            border: 2px solid var(--warning-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
        }

        .new-equipment-badge {
            position: absolute;
            top: -8px;
            right: 12px;
            background: var(--warning-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .system-selector {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--background-color);
            border-radius: var(--radius-medium);
            border: 1px solid var(--border-color);
        }

        .system-btn {
            padding: 12px 24px;
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-medium);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .system-btn:hover {
            border-color: var(--warning-color);
            background: var(--background-color);
            transform: translateY(-1px);
        }

        .system-btn.active {
            background: var(--warning-color);
            border-color: var(--warning-color);
            color: white;
            box-shadow: var(--shadow-medium);
        }

        .change-order-system-section {
            display: none;
        }

        .change-order-system-section.active {
            display: block;
        }

        /* Status */
        .file-info {
            padding: 16px;
            background: var(--surface-color);
            border-radius: var(--radius-medium);
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
        }

        .file-info strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Project Settings */
        .project-settings {
            background: var(--surface-color);
            border-radius: var(--radius-medium);
            padding: 16px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
        }

        .project-settings h3 {
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-group {
            margin-bottom: 12px;
        }

        .setting-group:last-child {
            margin-bottom: 0;
        }

        .setting-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .setting-group input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-small);
            font-size: 13px;
            background: var(--background-color);
            transition: var(--transition);
        }

        .setting-group input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: var(--surface-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .setting-group input::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        .stats-mini {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-mini {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            padding: 16px;
            border-radius: var(--radius-medium);
            text-align: center;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-mini:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .stat-mini::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-color);
        }

        .stat-mini-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .stat-mini-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .stat-mini.overhead-input {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .overhead-input-field {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            background: transparent;
            border: none;
            text-align: center;
            width: 100%;
            margin-bottom: 4px;
            padding: 0;
            outline: none;
        }

        .overhead-input-field:focus {
            background: rgba(0, 102, 204, 0.05);
            border-radius: 4px;
        }

        .stat-mini.total-hours {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border: 1px solid var(--primary-color);
        }

        .stat-mini.total-hours .stat-mini-value {
            color: white;
        }

        .stat-mini.total-hours .stat-mini-label {
            color: rgba(255, 255, 255, 0.9);
        }

        .stat-mini.total-hours::before {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--surface-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 16px 20px;
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-heavy);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            max-width: 350px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--error-color);
        }

        .toast-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            color: var(--success-color);
        }

        .toast.error .toast-icon {
            color: var(--error-color);
        }

        input[type="file"] {
            display: none;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 14px;
            line-height: 1.6;
        }

        /* Configuration Tab Styles */
        .config-tab {
            padding: 20px;
        }

        .config-section {
            background: var(--surface-color);
            border-radius: var(--radius-medium);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
        }

        .config-section h3 {
            margin-bottom: 16px;
            color: var(--primary-color);
            font-size: 16px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--background-color);
            border-radius: var(--radius-small);
            border: 1px solid var(--border-color);
        }

        .config-item-label {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .config-item-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-small);
            font-size: 12px;
            text-align: center;
        }

        /* SVG Icons */
        .icon {
            width: 16px;
            height: 16px;
            fill: currentColor;
            flex-shrink: 0;
        }

        .icon-large {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <!-- SVG Icon Definitions -->
    <svg style="display: none">
        <defs>
            <symbol id="icon-calculator" viewBox="0 0 24 24">
                <path d="M7 2h10c1.1 0 2 .9 2 2v16c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2zm0 2v4h10V4H7zm0 6v2h2v-2H7zm4 0v2h2v-2h-2zm4 0v2h2v-2h-2zm-8 4v2h2v-2H7zm4 0v2h2v-2h-2zm4 0v2h2v-2h-2zm-8 4v2h2v-2H7zm4 0v2h6v-2h-6z"/>
            </symbol>
            <symbol id="icon-qag-logo" viewBox="0 0 100 100">
                <!-- QAG Logo - simplified representation -->
                <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="4"/>
                <text x="50" y="40" text-anchor="middle" font-family="Arial, sans-serif" font-weight="bold" font-size="20" fill="currentColor">QAG</text>
                <text x="50" y="65" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="currentColor">GRAPHICS</text>
            </symbol>
            <symbol id="icon-upload" viewBox="0 0 24 24">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
            </symbol>
            <symbol id="icon-templates" viewBox="0 0 24 24">
                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h16c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
            </symbol>
            <symbol id="icon-settings" viewBox="0 0 24 24">
                <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
            </symbol>
            <symbol id="icon-download" viewBox="0 0 24 24">
                <path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/>
            </symbol>
            <symbol id="icon-building" viewBox="0 0 24 24">
                <path d="M12 2L2 7v10c0 5.55 3.84 9.71 9 11 5.16-1.29 9-5.45 9-11V7l-10-5z"/>
            </symbol>
            <symbol id="icon-plus" viewBox="0 0 24 24">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </symbol>
            <symbol id="icon-compare" viewBox="0 0 24 24">
                <path d="M9.01 14H2v2h7.01v3L13 15l-3.99-4v3zm5.98-1v-3H22V8h-7.01V5L11 9l3.99 4z"/>
            </symbol>
        </defs>
    </svg>

    <div class="app">
        <div class="header">
            <h1>
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAATIAAAByCAMAAADnN60vAAAAKlBMVEVHcEz///////////////////////////////////////////////////+LBpLMAAAADXRSTlMAQr+B2ZgQ7yBgMK9wl984bwAABjhJREFUeNrtXd1ytSoMJYHwp3n/1z2floKboqOmzpmC66ajmyhGwlpBoOrFixcvXrx48eL/AOBNzGpUGL4JrwZF4JvQSqkhG5p1fA/GKgU8os+IbyIopZCdVaPB801gimlSowH5JuA7pqMaC8B3kBqXTs1tLBi+B2dLTIMaCbNAYOSYNmog3BcYHzGt1Tggvgn4iGk3ThoQJQJDc8JQQgP5JnyO6cEYAAR9f4npkYSGlQgM+JE9jQAtSy4/YUZINb0TJZcJQwkNEiWXI443ipPLGpPqHShLLhNGEhqi0euJPzBGqilMLpvofExb8x7w9oBR32PanncRr8b0IKnmJHlqP+KHTTjgw6tRPUiqaXgP83nuGEpozLwHc0GhjCQ05I2kNNNBUk2Sd0XAPJLQ+BXCo6GEBvIeSDxy1OfH8zMx9QqNkz13uHadYYSGFumDttDoe0z7F1UoDiI0iPcwib8b9/nxPJ4QGK/QuBdMb6r5TJc99y807IHAkAqWTj+en5afb6qZ4H+/75k6FxqXGW74MW040FHSWO/04/kjw4K251TzssAYfkzbuocEATJ3+vHcwi6UCLF3ofE3iLh3WNerNjsOTLgJvwiNXoca8bD7J8EEPWU6zTOPu2nrBNNAodfRDDpeVs83EZcW3KeUVdYd5oNGMKXd90qXx/kgSBZO6F7H/4/zwUnAANb1JjAS4DAf9CxggNBbgnkuH9QSBjDd9f1f8BKhccwA0JvAOJcPBgkDUKezf6RC4yA18q4zgXHi06N0GbDuddTnWGiQZCcz08vY4jWhIWKAvy0wgBBnf/3To5ZsnIFtgeHJMLObtueD/odGtSe3LRp0BuzY5gKz/z4OpVgqsL24IZ99tN6M4nJgJ2Y0zOG60JAwQOQFuMvSaPNJ1+JVi1VR5AITm7Z1VpsqkIxTgc96uJCPC+FPbOAfHMOlVJN+ZSMIX3msNegILWK1pi6K/MO4tq3qv+8yqkTR/HEcGfX6XthcneMk326EGn2nCQCUHzT3Dq7RZSCkojrVhbTWZDKr1LbL1bXW6FIV2i5LmhMDzCaNGSwGGgDWY6UZNCtiNbG/9OkRpZvazD8EhsmOCqUJ2p9pVbpxyEVdemrIoYEt2+V8bqJhx2WlHqngrCAdp5usLmM2i+9ujGlLGMCE+vWUiKIP761HdQTjxtFx6zKff6xsl/PZqXrXZVDqEdcisBTPu+qG1WXIURHDRaFhhWuofaPjnDfNCHNsWVNpXlM3u+SyXOWpst1zmYEVZusyvXlBABDXCzrty6slzZ5JGb4zpq0lDKD2HnrTE/v1+SnHYfl1x9pCCrvKtg5M+KCD4rKqHoV32dDsUwdPqDQi04WZZmUwVR9i4n3jpsvs9iBlbQtJVdODvkVwxC/EqgchVdlmq0wQ/oLLQomO8NWMCWZkY5+Y42ROGxcvlYN0AZv/1C6D0jViFfYN28qp512m4vRJe7iGqn1kOQ3wWeNc1RILObZUHZmL/YHLmFRte0HKYqtyNpDZZsXgb6aaklG32rg8msXoU4GVzRHRfBq4pEH8EmfFZbCcmpM/f9oys8MFOqoDl1HyS8mpEnwwyeT5HXjb0A0NiKl3xtQSTHt+6LQx37os/wgt2+p52y7L9SjEHRAxZmmPj27DaM7OIS3CMxTCCfWd5w/vulgqB7WUhYbtOZflepRXM5cXZJjx2b245sM2OrVuo70Ct/o7ndGwYP6MTJOkkg2u7bKG7TmXlXqkTt+r+P0ofjkxPbvrj7NX5sNbUzt0MbWl+4rt/rXtstr2pMvqeuj6rcPDGxfThWWdtc8o6/iSQmUEl107NVw2N2xPu0xFUypR1ys8/v834NruJPqrrCNaHDojImz+aQqpAk9fJbUKa+dMiBhzSWzZVlcox6vx14mUz+sk+EF9HPMEz++Th1enyPo084+MPTNz8NFpiV4VxOpuDwqNcHeK7J//9OT5NgN0vkhiHyRhAOh3kcQTQmOVBlO3iySOECQMYN2QiySMhAHmIRdJgIQBFA608U/BJGGA2P96/Aa8iAF09+vxW9ASBlBmRAawIgaAIRkgiBiAhmQAlDCAdSMyALCEAWBIBiARA+CQDKDvwi8ypdtVvy9evHjxYjT8B5GvsSxWBvj8AAAAAElFTkSuQmCC" alt="QAG Logo" class="logo-img">
                Quote Tool
            </h1>
            <div class="nav-buttons">
                <!-- TODO: Update links to actual file paths -->
                <a href="https://qagraphics1.github.io/metasys-compare-tool/" class="nav-button">Metasys Explorer</a>
                <a href="https://qagraphics1.github.io/niagara-compare-tool/" class="nav-button">Niagara Navigator</a>
                <a href="https://qagraphics1.github.io/quote-tool/" class="nav-button active">Quote Tool</a>
            </div>
        </div>

        <div class="toolbar">
            <button class="btn quote-export" onclick="exportQuote()" id="exportQuoteBtn" style="display: none;">
                <svg class="icon"><use href="#icon-download"></use></svg>
                Export Quote
            </button>
            <button class="btn scope-export" onclick="exportScopeOfWork()" id="exportScopeBtn" style="display: none;">
                <svg class="icon"><use href="#icon-download"></use></svg>
                Export Scope of Work
            </button>
            <button class="btn clear-data" onclick="clearAllData()" id="clearDataBtn" style="background: #dc3545; color: white; margin-left: auto;">
                <svg class="icon" style="width: 16px; height: 16px; fill: currentColor;">
                    <path d="M6 2L4 4v12a2 2 0 002 2h8a2 2 0 002-2V4l-2-2H6zM8 6h2v8H8V6zm4 0h2v8h-2V6z"/>
                </svg>
                Clear All Data
            </button>
        </div>

        <div class="main">
            <div class="sidebar">
                <div class="file-info">
                    <input type="file" id="niagaraFileInput" accept=".csv" onchange="loadNiagaraFile(event)">
                    <input type="file" id="johnsonFileInput" accept=".csv" onchange="loadJohnsonFile(event)" style="display: none;">
                    <strong>Current Project:</strong> <span id="currentProject">None</span>
                </div>

                <div class="project-settings">
                    <h3>
                        <svg class="icon"><use href="#icon-settings"></use></svg>
                        Project Settings
                    </h3>
                    <div class="setting-group">
                        <label>Project Name</label>
                        <input type="text" id="projectName" placeholder="Auto-filled from CSV filename">
                    </div>
                    <div class="setting-group">
                        <label>Created By</label>
                        <input type="text" id="createdBy" placeholder="Quote Tool" value="Quote Tool">
                    </div>
                    <div class="setting-group">
                        <label>PO#</label>
                        <input type="text" id="poNumber" placeholder="Purchase Order Number">
                    </div>
                </div>

                <script>
                    // Add auto-save listeners to project settings inputs
                    document.addEventListener('DOMContentLoaded', function() {
                        const projectNameInput = document.getElementById('projectName');
                        const createdByInput = document.getElementById('createdBy');
                        const poNumberInput = document.getElementById('poNumber');

                        if (projectNameInput) {
                            projectNameInput.addEventListener('input', function() {
                                saveToLocalStorage();
                            });
                        }

                        if (createdByInput) {
                            createdByInput.addEventListener('input', function() {
                                saveToLocalStorage();
                            });
                        }

                        if (poNumberInput) {
                            poNumberInput.addEventListener('input', function() {
                                saveToLocalStorage();
                            });

                            // Add event listener for overhead percentage input
                            const overheadInput = document.getElementById('overheadPercentage');
                            if (overheadInput) {
                                overheadInput.addEventListener('input', function() {
                                    saveToLocalStorage();
                                    updateStats(); // Recalculate totals when overhead changes
                                });
                            }
                        }
                    });
                </script>

                <div class="stats-mini">
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="templateCount">0</div>
                        <div class="stat-mini-label">Templates</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="deviceCount">0</div>
                        <div class="stat-mini-label">Equipment</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="configuredCount">0</div>
                        <div class="stat-mini-label">Configured</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="baseHours">0</div>
                        <div class="stat-mini-label">Base Hours</div>
                    </div>
                    <div class="stat-mini overhead-input">
                        <input type="number" id="overheadPercentage" min="0" max="100" step="1" value="0" class="overhead-input-field">
                        <div class="stat-mini-label">Overhead %</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="overheadHours">0</div>
                        <div class="stat-mini-label">Overhead Hours</div>
                    </div>
                    <div class="stat-mini total-hours">
                        <div class="stat-mini-value" id="totalHours">0</div>
                        <div class="stat-mini-label">Total Hours</div>
                    </div>
                </div>

            </div>

            <div class="content">
                <div class="tab-container">
                    <div class="tab-nav">
                        <button class="tab-btn active" onclick="showTab(event, 'niagara')">
                            <svg class="icon"><use href="#icon-building"></use></svg>
                            Niagara Templates
                        </button>
                        <button class="tab-btn" onclick="showTab(event, 'johnson')">
                            <svg class="icon"><use href="#icon-building"></use></svg>
                            Johnson Templates
                        </button>
                        <button class="tab-btn" onclick="showTab(event, 'changeOrder')">
                            <svg class="icon"><use href="#icon-compare"></use></svg>
                            Change Order
                        </button>
                        <button class="tab-btn" onclick="showTab(event, 'config')">
                            <svg class="icon"><use href="#icon-settings"></use></svg>
                            Template Configuration
                        </button>
                    </div>

                    <div id="niagaraTab" class="tab-content active">
                        <div class="templates-report">
                            <div class="summary-card">
                                <h2>🏗️ Niagara Templates</h2>
                                <p style="margin-top: 8px; opacity: 0.9;">Import CSV exports from Niagara stations to generate equipment templates and quotes.</p>
                                <div style="margin-top: 16px;">
                                    <button class="btn primary" onclick="openNiagaraFile()">
                                        <svg class="icon"><use href="#icon-upload"></use></svg>
                                        Import Niagara CSV
                                    </button>
                                </div>
                            </div>

                            <!-- Niagara Exclude Section -->
                            <div class="exclude-section" style="margin-top: 20px;">
                                <div class="summary-card">
                                    <h3>🚫 Exclude Devices</h3>
                                    <p style="margin-top: 8px; opacity: 0.9;">Navigate through the device hierarchy and exclude items from templates.</p>
                                    <div id="niagaraExcludeList" style="margin-top: 12px;">
                                        <!-- Niagara exclude list will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <div id="niagaraTemplatesContent"></div>
                        </div>
                    </div>

                    <div id="johnsonTab" class="tab-content">
                        <div class="templates-report">
                            <div class="summary-card">
                                <h2>🏗️ Johnson Controls Templates</h2>
                                <p style="margin-top: 8px; opacity: 0.9;">Import CSV exports from Metasys systems to generate equipment templates and quotes.</p>
                                <div style="margin-top: 16px; display: flex; gap: 12px; align-items: center;">
                                    <button class="btn primary" onclick="openJohnsonFile()">
                                        <svg class="icon"><use href="#icon-upload"></use></svg>
                                        Import Johnson CSV
                                    </button>
                                    <button class="btn" onclick="toggleJohnsonDisplayNames()" id="johnsonDisplayNamesBtn">
                                        <svg class="icon"><use href="#icon-templates"></use></svg>
                                        Display Names
                                    </button>
                                </div>
                            </div>

                            <!-- Johnson Exclude Section -->
                            <div class="exclude-section" style="margin-top: 20px;">
                                <div class="summary-card">
                                    <h3>🚫 Exclude Devices</h3>
                                    <p style="margin-top: 8px; opacity: 0.9;">Navigate through the device hierarchy and exclude items from templates.</p>
                                    <div id="johnsonExcludeList" style="margin-top: 12px;">
                                        <!-- Johnson exclude list will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <div id="johnsonTemplatesContent"></div>
                        </div>
                    </div>

                    <div id="changeOrderTab" class="tab-content">
                        <div class="change-order-container">
                            <div class="change-order-header">
                                <h2>🔄 Change Order - Project Additions</h2>
                                <p>Compare two CSV files to identify new equipment and generate quotes for project additions.</p>
                            </div>

                            <!-- System Selector -->
                            <div class="system-selector">
                                <button class="system-btn active" onclick="selectChangeOrderSystem('niagara')" id="niagaraSystemBtn">
                                    <svg class="icon"><use href="#icon-building"></use></svg>
                                    Niagara Change Order
                                </button>
                                <button class="system-btn" onclick="selectChangeOrderSystem('johnson')" id="johnsonSystemBtn">
                                    <svg class="icon"><use href="#icon-building"></use></svg>
                                    Johnson Change Order
                                </button>
                            </div>

                            <!-- Niagara Change Order Section -->
                            <div id="niagaraChangeOrderSection" class="change-order-system-section active">
                                <div class="change-order-steps">
                                    <!-- Step 1: Original CSV -->
                                    <div class="change-order-step">
                                        <div class="step-header">
                                            <div class="step-number">1</div>
                                            <h3>Load Original/Baseline Niagara CSV</h3>
                                        </div>
                                        <div class="step-content">
                                            <div class="file-upload-section">
                                                <input type="file" id="originalNiagaraFileInput" accept=".csv" onchange="loadOriginalNiagaraFile(event)" style="display: none;">
                                                <button class="btn primary" onclick="openOriginalNiagaraFile()" id="originalNiagaraUploadBtn">
                                                    <svg class="icon"><use href="#icon-upload"></use></svg>
                                                    Upload Original Niagara CSV
                                                </button>
                                                <div class="file-status" id="originalNiagaraFileStatus" style="display: none;">
                                                    <span class="file-name" id="originalNiagaraFileName">None</span>
                                                    <span class="file-stats" id="originalNiagaraFileStats"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 2: Updated CSV -->
                                    <div class="change-order-step">
                                        <div class="step-header">
                                            <div class="step-number">2</div>
                                            <h3>Load Updated/New Niagara CSV</h3>
                                        </div>
                                        <div class="step-content">
                                            <div class="file-upload-section">
                                                <input type="file" id="updatedNiagaraFileInput" accept=".csv" onchange="loadUpdatedNiagaraFile(event)" style="display: none;">
                                                <button class="btn primary" onclick="openUpdatedNiagaraFile()" id="updatedNiagaraUploadBtn" disabled>
                                                    <svg class="icon"><use href="#icon-upload"></use></svg>
                                                    Upload Updated Niagara CSV
                                                </button>
                                                <div class="file-status" id="updatedNiagaraFileStatus" style="display: none;">
                                                    <span class="file-name" id="updatedNiagaraFileName">None</span>
                                                    <span class="file-stats" id="updatedNiagaraFileStats"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 3: Comparison Results -->
                                    <div class="change-order-step" id="niagaraComparisonStep" style="display: none;">
                                        <div class="step-header">
                                            <div class="step-number">3</div>
                                            <h3>Niagara Comparison Results</h3>
                                        </div>
                                        <div class="step-content">
                                            <div id="niagaraComparisonResults"></div>
                                        </div>
                                    </div>

                                    <!-- Step 4: Configure New Templates -->
                                    <div class="change-order-step" id="niagaraTemplateConfigStep" style="display: none;">
                                        <div class="step-header">
                                            <div class="step-number">4</div>
                                            <h3>Configure New Niagara Equipment Templates</h3>
                                        </div>
                                        <div class="step-content">
                                            <div id="niagaraNewTemplatesContent"></div>
                                        </div>
                                    </div>

                                    <!-- Step 5: Export Change Order -->
                                    <div class="change-order-step" id="niagaraExportStep" style="display: none;">
                                        <div class="step-header">
                                            <div class="step-number">5</div>
                                            <h3>Export Niagara Change Order Quote</h3>
                                        </div>
                                        <div class="step-content">
                                            <button class="btn quote-export" onclick="exportNiagaraChangeOrder()">
                                                <svg class="icon"><use href="#icon-download"></use></svg>
                                                Export Niagara Change Order Quote
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Johnson Change Order Section -->
                            <div id="johnsonChangeOrderSection" class="change-order-system-section">
                                <div class="change-order-steps">
                                    <!-- Step 1: Original CSV -->
                                    <div class="change-order-step">
                                        <div class="step-header">
                                            <div class="step-number">1</div>
                                            <h3>Load Original/Baseline Johnson CSV</h3>
                                        </div>
                                        <div class="step-content">
                                            <div class="file-upload-section">
                                                <input type="file" id="originalJohnsonFileInput" accept=".csv" onchange="loadOriginalJohnsonFile(event)" style="display: none;">
                                                <button class="btn primary" onclick="openOriginalJohnsonFile()" id="originalJohnsonUploadBtn">
                                                    <svg class="icon"><use href="#icon-upload"></use></svg>
                                                    Upload Original Johnson CSV
                                                </button>
                                                <div class="file-status" id="originalJohnsonFileStatus" style="display: none;">
                                                    <span class="file-name" id="originalJohnsonFileName">None</span>
                                                    <span class="file-stats" id="originalJohnsonFileStats"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Step 2: Updated CSV -->
                                    <div class="change-order-step">
                                        <div class="step-header">
                                            <div class="step-number">2</div>
                                            <h3>Load Updated/New Johnson CSV</h3>
                                        </div>
                                        <div class="step-content">
                                            <div class="file-upload-section">
                                                <input type="file" id="updatedJohnsonFileInput" accept=".csv" onchange="loadUpdatedJohnsonFile(event)" style="display: none;">
                                                <button class="btn primary" onclick="openUpdatedJohnsonFile()" id="updatedJohnsonUploadBtn" disabled>
                                                    <svg class="icon"><use href="#icon-upload"></use></svg>
                                                    Upload Updated Johnson CSV
                                                </button>
                                                <div class="file-status" id="updatedJohnsonFileStatus" style="display: none;">
                                                    <span class="file-name" id="updatedJohnsonFileName">None</span>
                                                    <span class="file-stats" id="updatedJohnsonFileStats"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Step 3: Comparison Results -->
                                    <div class="change-order-step" id="johnsonComparisonStep" style="display: none;">
                                        <div class="step-header">
                                            <div class="step-number">3</div>
                                            <h3>Johnson Comparison Results</h3>
                                        </div>
                                        <div class="step-content">
                                            <div id="johnsonComparisonResults"></div>
                                        </div>
                                    </div>
                                    <!-- Step 4: Configure New Templates -->
                                    <div class="change-order-step" id="johnsonTemplateConfigStep" style="display: none;">
                                        <div class="step-header">
                                            <div class="step-number">4</div>
                                            <h3>Configure New Johnson Equipment Templates</h3>
                                        </div>
                                        <div class="step-content">
                                            <div id="johnsonNewTemplatesContent"></div>
                                        </div>
                                    </div>
                                    <!-- Step 5: Export Change Order -->
                                    <div class="change-order-step" id="johnsonExportStep" style="display: none;">
                                        <div class="step-header">
                                            <div class="step-number">5</div>
                                            <h3>Export Johnson Change Order Quote</h3>
                                        </div>
                                        <div class="step-content">
                                            <button class="btn quote-export" onclick="exportJohnsonChangeOrder()">
                                                <svg class="icon"><use href="#icon-download"></use></svg>
                                                Export Johnson Change Order Quote
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="configTab" class="tab-content">
                        <div class="config-tab">
                            <div class="config-section">
                                <h3>Default Hours Configuration</h3>
                                <p style="margin-bottom: 16px; color: var(--text-secondary);">
                                    Set default hour estimates for each equipment type and complexity level.
                                    These will be automatically applied when selecting types for templates.
                                </p>
                                <div id="configGrid" class="config-grid">
                                    <!-- Configuration items will be generated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Global state - separated by system
        let niagaraData = {
            devices: [],
            points: new Map(),
            templates: { exact: [], partial: [] },
            customTemplates: [],
            tree: null,
            settings: {}
        };

        let johnsonData = {
            devices: [],
            points: new Map(),
            templates: { exact: [], partial: [] },
            customTemplates: [],
            tree: null,
            settings: {}
        };

        // Change Order data structure
        let changeOrderData = {
            niagara: {
                originalData: null,        // Parsed data from first CSV
                updatedData: null,         // Parsed data from second CSV
                newEquipment: [],          // Equipment only in updated
                modifiedEquipment: [],     // Existing equipment with new points
                newTemplates: { exact: [], partial: [] }, // Templates for new equipment
                modifiedTemplates: { exact: [], partial: [] }, // Templates for modified equipment
                settings: {},              // Configuration for new templates
                comparisonDate: null       // When comparison was performed
            },
            johnson: {
                originalData: null,
                updatedData: null,
                newEquipment: [],
                modifiedEquipment: [],
                newTemplates: { exact: [], partial: [] },
                modifiedTemplates: { exact: [], partial: [] },
                settings: {},
                comparisonDate: null
            }
        };

        // Current active system
        let currentSystem = 'niagara';
        let currentTab = 'niagara';

        // Display name toggle state for Johnson
        let useJohnsonDisplayNames = false;

        // Track excluded top-level containers
        let excludedContainers = new Set();

        // Local Storage Functions
        function saveToLocalStorage() {
            try {
                const dataToSave = {
                    version: '1.0',
                    savedAt: new Date().toISOString(),
                    projectSettings: {
                        projectName: document.getElementById('projectName')?.value || '',
                        createdBy: document.getElementById('createdBy')?.value || 'Quote Tool',
                        poNumber: document.getElementById('poNumber')?.value || '',
                        overheadPercentage: parseFloat(document.getElementById('overheadPercentage')?.value || 0)
                    },
                    // Save only essential data, not full device arrays and points
                    niagaraData: {
                        templates: niagaraData.templates || {},
                        settings: niagaraData.settings || {},
                        customTemplates: niagaraData.customTemplates || []
                        // Don't save devices and points arrays to reduce size
                    },
                    johnsonData: {
                        templates: johnsonData.templates || {},
                        settings: johnsonData.settings || {},
                        customTemplates: johnsonData.customTemplates || []
                        // Don't save devices and points arrays to reduce size
                    },
                    // Save only essential change order data
                    changeOrderData: {
                        niagara: {
                            settings: changeOrderData?.niagara?.settings || {}
                            // Don't save full originalData and updatedData
                        }
                    },
                    uiState: {
                        currentTab: currentTab,
                        useJohnsonDisplayNames: useJohnsonDisplayNames,
                        excludedContainers: Array.from(excludedContainers),
                        niagaraExcludeLevel: niagaraExcludeLevel,
                        johnsonExcludeLevel: johnsonExcludeLevel
                    }
                };

                localStorage.setItem('quoteToolData', JSON.stringify(dataToSave));
                console.log('Data saved to localStorage (reduced size)');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                // Try to clear old data and retry
                try {
                    localStorage.removeItem('quoteToolData');
                    localStorage.setItem('quoteToolData', JSON.stringify(dataToSave));
                    console.log('Data saved after clearing old data');
                } catch (retryError) {
                    console.error('Failed to save even after clearing:', retryError);
                    showToast('Unable to save data locally - storage quota exceeded', 'error');
                }
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('quoteToolData');
                if (!savedData) return false;

                const data = JSON.parse(savedData);
                if (data.version !== '1.0') {
                    console.warn('Saved data version mismatch, skipping load');
                    return false;
                }

                // Restore project settings
                if (data.projectSettings) {
                    const projectNameInput = document.getElementById('projectName');
                    const createdByInput = document.getElementById('createdBy');
                    const poNumberInput = document.getElementById('poNumber');
                    const overheadPercentageInput = document.getElementById('overheadPercentage');

                    if (projectNameInput) projectNameInput.value = data.projectSettings.projectName || '';
                    if (createdByInput) createdByInput.value = data.projectSettings.createdBy || 'Quote Tool';
                    if (poNumberInput) poNumberInput.value = data.projectSettings.poNumber || '';
                    if (overheadPercentageInput) overheadPercentageInput.value = data.projectSettings.overheadPercentage || 0;
                }

                // Restore Niagara data (only essential data is saved)
                if (data.niagaraData) {
                    niagaraData = {
                        devices: [], // Will be empty until CSV is imported again
                        points: new Map(), // Will be empty until CSV is imported again
                        templates: data.niagaraData.templates || {},
                        settings: data.niagaraData.settings || {},
                        customTemplates: data.niagaraData.customTemplates || []
                    };
                }

                // Restore Johnson data (only essential data is saved)
                if (data.johnsonData) {
                    johnsonData = {
                        devices: [], // Will be empty until CSV is imported again
                        points: new Map(), // Will be empty until CSV is imported again
                        templates: data.johnsonData.templates || {},
                        settings: data.johnsonData.settings || {},
                        customTemplates: data.johnsonData.customTemplates || []
                    };
                }

                // Restore change order data
                if (data.changeOrderData) {
                    changeOrderData = data.changeOrderData;
                }

                // Restore UI state
                if (data.uiState) {
                    currentTab = data.uiState.currentTab || 'niagara';
                    useJohnsonDisplayNames = data.uiState.useJohnsonDisplayNames || false;
                    excludedContainers = new Set(data.uiState.excludedContainers || []);
                    niagaraExcludeLevel = data.uiState.niagaraExcludeLevel || [];
                    johnsonExcludeLevel = data.uiState.johnsonExcludeLevel || [];
                }

                console.log('Data loaded from localStorage');
                showToast(`Previous session restored (saved ${new Date(data.savedAt).toLocaleString()})`, 'success');
                return true;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                showToast('Error loading saved data', 'error');
                return false;
            }
        }

        function clearAllData() {
            if (!confirm('Are you sure you want to clear all data? This will remove all imported files, templates, and project settings. This action cannot be undone.')) {
                return;
            }

            try {
                // Clear localStorage
                localStorage.removeItem('quoteToolData');

                // Reset all global variables to initial state
                niagaraData = {
                    devices: [],
                    points: new Map(),
                    templates: { exact: [], partial: [] },
                    customTemplates: [],
                    tree: null,
                    settings: {}
                };

                johnsonData = {
                    devices: [],
                    points: new Map(),
                    templates: { exact: [], partial: [] },
                    customTemplates: [],
                    tree: null,
                    settings: {}
                };

                changeOrderData = {
                    niagara: {
                        originalData: null,
                        updatedData: null,
                        newEquipment: [],
                        modifiedEquipment: [],
                        newTemplates: { exact: [], partial: [] },
                        modifiedTemplates: { exact: [], partial: [] },
                        settings: {},
                        comparisonDate: null
                    },
                    johnson: {
                        originalData: null,
                        updatedData: null,
                        newEquipment: [],
                        modifiedEquipment: [],
                        newTemplates: { exact: [], partial: [] },
                        modifiedTemplates: { exact: [], partial: [] },
                        settings: {},
                        comparisonDate: null
                    }
                };

                // Reset project settings
                const projectNameInput = document.getElementById('projectName');
                const createdByInput = document.getElementById('createdBy');
                const poNumberInput = document.getElementById('poNumber');

                if (projectNameInput) projectNameInput.value = '';
                if (createdByInput) createdByInput.value = 'Quote Tool';
                if (poNumberInput) poNumberInput.value = '';

                // Reset UI state
                currentTab = 'niagara';
                useJohnsonDisplayNames = false;
                excludedContainers = new Set();
                niagaraExcludeLevel = [];
                johnsonExcludeLevel = [];

                // Clear change order UI elements
                const niagaraComparisonResults = document.getElementById('niagaraComparisonResults');
                const niagaraNewTemplatesContent = document.getElementById('niagaraNewTemplatesContent');
                const johnsonComparisonResults = document.getElementById('johnsonComparisonResults');
                const johnsonNewTemplatesContent = document.getElementById('johnsonNewTemplatesContent');

                if (niagaraComparisonResults) niagaraComparisonResults.innerHTML = '';
                if (niagaraNewTemplatesContent) niagaraNewTemplatesContent.innerHTML = '';
                if (johnsonComparisonResults) johnsonComparisonResults.innerHTML = '';
                if (johnsonNewTemplatesContent) johnsonNewTemplatesContent.innerHTML = '';

                // Hide change order workflow steps
                const niagaraComparisonStep = document.getElementById('niagaraComparisonStep');
                const niagaraTemplateConfigStep = document.getElementById('niagaraTemplateConfigStep');
                const niagaraExportStep = document.getElementById('niagaraExportStep');
                const johnsonComparisonStep = document.getElementById('johnsonComparisonStep');
                const johnsonTemplateConfigStep = document.getElementById('johnsonTemplateConfigStep');
                const johnsonExportStep = document.getElementById('johnsonExportStep');

                if (niagaraComparisonStep) niagaraComparisonStep.style.display = 'none';
                if (niagaraTemplateConfigStep) niagaraTemplateConfigStep.style.display = 'none';
                if (niagaraExportStep) niagaraExportStep.style.display = 'none';
                if (johnsonComparisonStep) johnsonComparisonStep.style.display = 'none';
                if (johnsonTemplateConfigStep) johnsonTemplateConfigStep.style.display = 'none';
                if (johnsonExportStep) johnsonExportStep.style.display = 'none';

                // Clear file inputs
                const originalNiagaraFileInput = document.getElementById('originalNiagaraFileInput');
                const updatedNiagaraFileInput = document.getElementById('updatedNiagaraFileInput');
                const originalJohnsonFileInput = document.getElementById('originalJohnsonFileInput');
                const updatedJohnsonFileInput = document.getElementById('updatedJohnsonFileInput');

                if (originalNiagaraFileInput) originalNiagaraFileInput.value = '';
                if (updatedNiagaraFileInput) updatedNiagaraFileInput.value = '';
                if (originalJohnsonFileInput) originalJohnsonFileInput.value = '';
                if (updatedJohnsonFileInput) updatedJohnsonFileInput.value = '';

                // Update the UI
                updateCurrentTabContent();
                updateStats();
                updateExportButton();

                showToast('All data cleared successfully', 'success');
                console.log('All data cleared');
            } catch (error) {
                console.error('Error clearing data:', error);
                showToast('Error clearing data', 'error');
            }
        }

        // Template type configuration
        const templateTypes = [
            'Air Systems',
            'Water Systems',
            'Terminal Units',
            'Floor Plans',
            'Misc Systems',
            'Navigation',
            'Summary'
        ];

        const complexityLevels = ['Simple', 'Typical', 'Complex'];

        // Default hours configuration
        let defaultHours = {};

        // Initialize default hours
        function initializeDefaultHours() {
            templateTypes.forEach(type => {
                defaultHours[type] = {};
                complexityLevels.forEach(complexity => {
                    // Set some default values
                    let hours = 0.5; // Default
                    if (complexity === 'Typical') hours = 1.0;
                    if (complexity === 'Complex') hours = 2.0;
                    if (type === 'Air Systems' && complexity === 'Complex') hours = 3.0;
                    if (type === 'Water Systems' && complexity === 'Complex') hours = 2.5;

                    defaultHours[type][complexity] = hours;
                });
            });
        }

        // Template settings management
        function updateTemplateName(system, index, name) {
            const data = system === 'niagara' ? niagaraData : johnsonData;
            if (!data.settings[index]) data.settings[index] = {};
            data.settings[index].name = name;
            updateStats();
            updateExportButton();
            saveToLocalStorage(); // Auto-save after template change
        }

        function updateTemplateType(system, index, type, complexity) {
            const data = system === 'niagara' ? niagaraData : johnsonData;
            if (!data.settings[index]) data.settings[index] = {};
            data.settings[index].type = type;
            data.settings[index].complexity = complexity;

            // Auto-fill hours from defaults if type and complexity are set
            if (type && complexity && defaultHours[type] && defaultHours[type][complexity]) {
                data.settings[index].hours = defaultHours[type][complexity];
                // Update the hours input field
                const hoursInput = document.querySelector(`input[data-template="${index}"][data-field="hours"]`);
                if (hoursInput) {
                    hoursInput.value = defaultHours[type][complexity];
                }
            }

            updateStats();
            updateExportButton();
            saveToLocalStorage(); // Auto-save after template change
        }

        function updateTemplateHours(system, index, hours) {
            const data = system === 'niagara' ? niagaraData : johnsonData;
            if (!data.settings[index]) data.settings[index] = {};
            data.settings[index].hours = parseFloat(hours) || 0;
            updateStats();
            updateExportButton();
            saveToLocalStorage(); // Auto-save after template change
        }

        function updateTemplateDescription(system, index, description) {
            const data = system === 'niagara' ? niagaraData : johnsonData;
            if (!data.settings[index]) data.settings[index] = {};
            data.settings[index].description = description;
        }

        function updateTemplateQuantity(system, index, quantity) {
            const data = system === 'niagara' ? niagaraData : johnsonData;
            if (!data.settings[index]) data.settings[index] = {};
            data.settings[index].customQuantity = parseInt(quantity) || null;
            updateStats();
            updateExportButton();
            saveToLocalStorage(); // Auto-save after template change
        }

        function hasConfiguredTemplates() {
            const niagaraConfigured = Object.values(niagaraData.settings).some(s => s.name && (s.hours > 0 || (s.type && s.complexity)));
            const niagaraCustomConfigured = niagaraData.customTemplates.some(t => t.name && (t.hours > 0 || (t.type && t.complexity)));
            const johnsonConfigured = Object.values(johnsonData.settings).some(s => s.name && (s.hours > 0 || (s.type && s.complexity)));
            const johnsonCustomConfigured = johnsonData.customTemplates.some(t => t.name && (t.hours > 0 || (t.type && t.complexity)));
            return niagaraConfigured || niagaraCustomConfigured || johnsonConfigured || johnsonCustomConfigured;
        }

        // File handling
        function openNiagaraFile() {
            document.getElementById('niagaraFileInput').click();
        }

        function openJohnsonFile() {
            document.getElementById('johnsonFileInput').click();
        }

        async function loadNiagaraFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const csvContent = await loadCSV(file);
                const csvData = processNiagaraCSV(csvContent);

                // Preserve existing custom templates when loading new CSV data
                const existingCustomTemplates = niagaraData.customTemplates || [];
                niagaraData = { ...csvData, customTemplates: existingCustomTemplates };

                currentSystem = 'niagara';

                document.getElementById('currentProject').textContent = file.name;
                updateProjectName(file.name);
                updateDisplay();
                updateNiagaraExcludeList(); // Update exclude list after loading
                saveToLocalStorage(); // Auto-save after loading file
                showToast('Niagara file loaded successfully');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error loading Niagara file', 'error');
            }
        }

        async function loadJohnsonFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const csvContent = await loadCSV(file);
                const csvData = processJohnsonCSV(csvContent);

                // Preserve existing custom templates when loading new CSV data
                const existingCustomTemplates = johnsonData.customTemplates || [];
                johnsonData = { ...csvData, customTemplates: existingCustomTemplates };

                currentSystem = 'johnson';
                document.getElementById('currentProject').textContent = file.name;
                updateProjectName(file.name);
                updateDisplay();
                updateJohnsonExcludeList(); // Update exclude list after loading
                saveToLocalStorage(); // Auto-save after loading file
                showToast('Johnson file loaded successfully');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error loading Johnson file', 'error');
            }
        }

        async function loadCSV(file) {
            if (!file.name.endsWith('.csv')) {
                throw new Error('Please upload a CSV file');
            }
            return await file.text();
        }

        // Niagara-specific CSV processing (separated from original logic)
        function processNiagaraCSV(csvContent) {
            // Remove UTF-8 BOM if present
            if (csvContent.charCodeAt(0) === 0xFEFF) {
                csvContent = csvContent.slice(1);
            }

            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length === 0) {
                throw new Error('Empty CSV file');
            }

            // Parse CSV - assume first line is header
            const header = lines[0].split(',');
            const objectIndex = header.findIndex(col => col.trim().toLowerCase() === 'object');

            if (objectIndex === -1) {
                throw new Error('No Object column found in CSV');
            }

            // Step 1: Build path tree and collect all paths
            const pathTree = {};
            const allPaths = new Set();
            const pointPaths = new Set();

            // Process each CSV row (skip header)
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const cols = line.split(',');
                let pointPath = cols[objectIndex]?.trim();

                // Remove surrounding quotes if present (some CSV exports quote values)
                if (pointPath && pointPath.startsWith('"') && pointPath.endsWith('"')) {
                    pointPath = pointPath.slice(1, -1);
                }

                if (!pointPath || !pointPath.startsWith('/')) continue;

                allPaths.add(pointPath);
                pointPaths.add(pointPath);

                // Build tree structure
                const segments = pointPath.split('/').filter(s => s);
                let currentNode = pathTree;
                let currentPath = '';

                segments.forEach((segment, index) => {
                    currentPath += '/' + segment;

                    if (!currentNode[segment]) {
                        currentNode[segment] = {
                            name: segment,
                            path: currentPath,
                            children: {},
                            isPoint: false,
                            points: [],
                            isEquipment: false
                        };
                    }

                    // Mark as point if it's the final segment
                    if (index === segments.length - 1) {
                        currentNode[segment].isPoint = true;
                    }

                    allPaths.add(currentPath);
                    currentNode = currentNode[segment].children;
                });
            }

            console.log('Built path tree with', allPaths.size, 'total paths and', pointPaths.size, 'point paths');

            // Step 2: Identify equipment by working backwards from each point
            const equipmentMap = new Map();
            const points = new Map();

            pointPaths.forEach(pointPath => {
                const segments = pointPath.split('/').filter(s => s);
                const pointName = segments.pop(); // Remove the point name

                // Determine equipment by working backwards
                let equipmentPath;
                let equipmentName;

                if (segments.length > 0 && segments[segments.length - 1] === 'points') {
                    // If parent is "points", equipment is one level up
                    segments.pop(); // Remove "points"
                    if (segments.length > 0) {
                        equipmentName = segments[segments.length - 1];
                        equipmentPath = '/' + segments.join('/');
                    } else {
                        // Edge case: if we have /points/pointName, skip it
                        return;
                    }
                } else {
                    // Otherwise, parent folder is the equipment
                    if (segments.length > 0) {
                        equipmentName = segments[segments.length - 1];
                        equipmentPath = '/' + segments.join('/');
                    } else {
                        // Edge case: point at root level, skip it
                        return;
                    }
                }

                // Create equipment if it doesn't exist
                if (!equipmentMap.has(equipmentPath)) {
                    equipmentMap.set(equipmentPath, {
                        name: equipmentName,
                        path: equipmentPath,
                        points: [],
                        hasPointsFolder: pointPath.includes('/points/')
                    });
                }

                // Create point object
                const point = {
                    name: pointName,
                    path: pointPath,
                    hasPointsFolder: pointPath.includes('/points/'),
                    equipmentPath: equipmentPath
                };

                // Add point to maps
                points.set(pointPath, point);
                equipmentMap.get(equipmentPath).points.push(point);
            });

            console.log('Found', equipmentMap.size, 'equipment and', points.size, 'points');

            // Convert to arrays and sort
            const devices = Array.from(equipmentMap.values());
            devices.forEach(device => {
                device.points.sort((a, b) => a.name.localeCompare(b.name));
            });

            // Find templates
            const templates = findTemplates(devices);

            // Build tree (simplified since we don't need tree view)
            const tree = { name: 'Station', children: [] };

            console.log('Niagara CSV Processing Results:', {
                devices: devices.length,
                points: points.size,
                templates: templates.exact.length
            });

            return {
                devices,
                points,
                templates,
                tree,
                paths: Array.from(allPaths),
                settings: {},
                customTemplates: []
            };
        }

        // Johnson Controls/Metasys CSV processing (exact logic from metasys-mapper.html)
        function processJohnsonCSV(csvContent) {
            // Remove UTF-8 BOM if present
            if (csvContent.charCodeAt(0) === 0xFEFF) {
                csvContent = csvContent.slice(1);
            }

            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length === 0) {
                throw new Error('Empty CSV file');
            }

            // Parse CSV - check for two-column format (path, type) or single column
            const header = lines[0].split(',');
            const hasTypeColumn = header.length >= 2;
            const hasDisplayColumn = header.length >= 3;

            let pathIndex = 0;
            let typeIndex = 1;
            let displayIndex = 2;

            if (!hasTypeColumn) {
                // Legacy single column format - find path column
                pathIndex = header.findIndex(col => {
                    const normalized = col.trim().toLowerCase();
                    return normalized === 'fullpath' || normalized === 'object';
                });
                if (pathIndex === -1) {
                    throw new Error('No FullPath or Object column found in CSV');
                }
                typeIndex = -1; // No type column
            }

            console.log(`CSV format detected: ${hasDisplayColumn ? 'Three-column (path + type + display)' : hasTypeColumn ? 'Two-column (path + type)' : 'Single-column (path only)'}`);

            // Step 1: Parse Metasys CSV structure with proper tier logic
            const equipmentMap = new Map();
            const points = new Map();
            const allCleanPaths = new Set();
            let currentEquipment = null;

            // Helper function to convert full path to clean tier path
            function pathToTierPath(fullPath) {
                // AMLRiver/$site/ARG-RIS-APP-04:SNE-01/FC-A/FC-A.01ACGM004/FC-A.01ACGM004.CLG-EN
                // becomes: AMLRiver/SNE-01/FC-A/01ACGM004/CLG-EN

                console.log(`pathToTierPath input: ${fullPath}`);

                let path = fullPath;

                // Extract site name (before /$site/)
                const siteMatch = path.match(/^([^\/]+)\/\$site\//);
                const siteName = siteMatch ? siteMatch[1] : '';

                // Remove site prefix
                path = path.replace(/^[^\/]+\/\$site\//, '');

                // Extract controller name (after colon)
                path = path.replace(/([^:]+):([^\/]+)/, '$2');

                console.log(`After processing controller: ${path}`);

                // Split by slashes and process each segment
                const segments = path.split('/');
                const cleanSegments = [siteName]; // Start with site name

                console.log(`Segments to process:`, segments);

                for (let i = 0; i < segments.length; i++) {
                    const segment = segments[i];
                    if (!segment) continue;

                    // Check if this is the last segment and it's a point (equipment.POINTNAME format)
                    const isLastSegment = i === segments.length - 1;
                    const previousSegment = i > 0 ? segments[i - 1] : '';
                    // Fix: Point segment must have equipment name + additional point suffix
                    // Equipment: "FC-B.02BCGM024" (just equipment name)
                    // Point: "FC-B.02BCGM024.CLG-EN" (equipment name + point suffix)
                    const isPointSegment = isLastSegment &&
                                          segment.includes('.') &&
                                          segment.startsWith(previousSegment + '.') &&
                                          segment.length > previousSegment.length + 1;

                    console.log(`Processing segment ${i}: "${segment}", isPointSegment: ${isPointSegment}`);

                    if (isPointSegment) {
                        // For point segments like "FC-A.01ACGM004.CLG-EN", extract just the point name "CLG-EN"
                        const lastDotIndex = segment.lastIndexOf('.');
                        const pointName = segment.substring(lastDotIndex + 1);
                        cleanSegments.push(pointName);
                        console.log(`  Point segment: extracted "${pointName}"`);
                    } else if (segment.includes('.')) {
                        // For equipment segments like "FC-A.01ACGM004", extract "01ACGM004"
                        const dotIndex = segment.indexOf('.');
                        const afterDot = segment.substring(dotIndex + 1);
                        cleanSegments.push(afterDot);
                        console.log(`  Equipment segment: extracted "${afterDot}"`);
                    } else {
                        // Regular segments (like FC-A) - keep as-is
                        cleanSegments.push(segment);
                        console.log(`  Regular segment: kept "${segment}"`);
                    }
                }

                const result = cleanSegments.filter(s => s).join('/');
                console.log(`pathToTierPath result: ${result}`);
                return result;
            }

            // Process each CSV row (skip header)
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const cols = line.split(',');

                // Helper function to remove surrounding quotes from CSV values
                const unquote = (val) => {
                    if (val && val.startsWith('"') && val.endsWith('"')) {
                        return val.slice(1, -1);
                    }
                    return val;
                };

                const fullPath = unquote(cols[pathIndex]?.trim());
                const itemType = hasTypeColumn ? unquote(cols[typeIndex]?.trim()) : null;
                const displayName = hasDisplayColumn ? unquote(cols[displayIndex]?.trim()) : null;

                if (!fullPath) continue;

                // Convert to clean tier path
                const cleanPath = pathToTierPath(fullPath);
                allCleanPaths.add(cleanPath);

                console.log(`Processing: "${fullPath}" | Type: ${itemType || 'AUTO-DETECT'}`);

                let isEquipment = false;
                let isPoint = false;

                if (hasTypeColumn) {
                    // Use type column for definitive classification
                    isEquipment = itemType === 'Equipment';
                    isPoint = itemType === 'Point';
                    // Container types are skipped (neither equipment nor point)
                } else {
                    // Legacy detection for single-column CSV
                    const afterSite = fullPath.split('/$site/')[1];
                    if (!afterSite) continue;

                    const segmentsAfterSite = afterSite.split('/');
                    isPoint = segmentsAfterSite.length === 4;
                    isEquipment = !isPoint;
                }

                console.log(`  -> ${isEquipment ? 'EQUIPMENT' : isPoint ? 'POINT' : 'CONTAINER (skipped)'}`);

                if (isEquipment) {
                    // This is an equipment row
                    const pathSegments = cleanPath.split('/');
                    const equipmentName = pathSegments[pathSegments.length - 1]; // Last segment is equipment

                    currentEquipment = {
                        name: equipmentName,
                        displayName: displayName,
                        path: fullPath, // Keep original path for reference
                        cleanPath: cleanPath,
                        points: []
                    };

                    equipmentMap.set(fullPath, currentEquipment);
                    console.log(`  -> Stored equipment: "${equipmentName}" with cleanPath: "${cleanPath}"`);
                } else if (isPoint && currentEquipment) {
                    // This is a point row
                    const pathSegments = cleanPath.split('/');
                    const pointName = pathSegments[pathSegments.length - 1]; // Last segment is point name

                    const point = {
                        name: pointName,
                        displayName: displayName,
                        path: fullPath,
                        cleanPath: cleanPath,
                        equipmentPath: currentEquipment.path
                    };

                    points.set(fullPath, point);
                    currentEquipment.points.push(point);
                    console.log(`  -> Added point "${pointName}" to equipment "${currentEquipment.name}"`);
                } else if (isPoint && !currentEquipment) {
                    console.log(`  -> ERROR: Point found but no current equipment! Point path: ${fullPath}`);
                }
                // Containers are ignored (neither equipment nor point)
            }

            console.log('Found', equipmentMap.size, 'equipment and', points.size, 'points');

            // Convert to arrays and sort
            const devices = Array.from(equipmentMap.values());
            devices.forEach(device => {
                device.points.sort((a, b) => a.name.localeCompare(b.name));
            });

            // Find templates
            const templates = findTemplates(devices);

            // Build tree (simplified since we don't need tree view)
            const tree = { name: 'Station', children: [] };

            console.log('Johnson CSV Processing Results:', {
                devices: devices.length,
                points: points.size,
                templates: templates.exact.length
            });

            return {
                devices,
                points,
                templates,
                tree,
                paths: Array.from(allCleanPaths),
                settings: {},
                customTemplates: []
            };
        }

        // Separate drill-down navigation state for each tab
        let niagaraExcludeLevel = [];
        let johnsonExcludeLevel = [];

        // Parse devices for drill-down navigation
        function parseDevicesForDrillDown(devices, dataType) {
            console.log(`Parsing ${devices.length} devices for drill-down navigation (${dataType})`);
            const levels = {};

            devices.forEach(device => {
                console.log(`Processing device: ${device.path} (${device.name})`);
                const originalPath = device.path;
                let pathParts = device.path.split('/').filter(p => p);

                // Different parsing logic for Johnson vs Niagara
                if (dataType === 'johnson') {
                    // Johnson paths like "FC-B.01.AHU-001" - split by dots for deeper levels
                    if (pathParts.length > 0) {
                        const mainPath = pathParts[0];
                        const subParts = mainPath.split('.');
                        pathParts = [...subParts, ...pathParts.slice(1)];
                    }
                } else if (dataType === 'niagara') {
                    // Niagara paths - handle various structures more flexibly
                    // Remove common system prefixes like Drivers, stations, etc.
                    if (pathParts.length > 0 && (pathParts[0] === 'Drivers' || pathParts[0] === 'drivers')) {
                        pathParts = pathParts.slice(1); // Skip 'Drivers' prefix
                    }

                    // Handle site structure (legacy logic)
                    if (pathParts.length > 2 && (pathParts[0].includes('AML') || pathParts[0].includes('River') || pathParts[1].includes('SNE'))) {
                        pathParts = pathParts.slice(2); // Skip site/project prefixes
                    }

                    // Remove 'points' folders from path hierarchy for cleaner navigation
                    pathParts = pathParts.filter(part => part !== 'points');
                }

                console.log(`  Original path: ${originalPath}`);
                console.log(`  Parsed path parts: [${pathParts.join(', ')}]`);

                // Build level structure
                for (let depth = 0; depth < pathParts.length; depth++) {
                    const levelKey = pathParts.slice(0, depth + 1).join('/');
                    const parentKey = depth > 0 ? pathParts.slice(0, depth).join('/') : '';

                    if (!levels[parentKey]) {
                        levels[parentKey] = [];
                    }

                    const existingItem = levels[parentKey].find(item => item.name === pathParts[depth]);
                    if (!existingItem) {
                        levels[parentKey].push({
                            name: pathParts[depth],
                            fullPath: device.path,
                            levelPath: levelKey,
                            displayName: depth === pathParts.length - 1 ? (device.displayName || device.name || pathParts[depth]) : pathParts[depth],
                            hasChildren: depth < pathParts.length - 1,
                            isDevice: depth === pathParts.length - 1
                        });
                    }
                }
            });

            // Sort each level
            Object.keys(levels).forEach(key => {
                levels[key].sort((a, b) => a.displayName.localeCompare(b.displayName));
            });

            console.log(`Drill-down parsing complete. Found ${Object.keys(levels).length} levels:`, Object.keys(levels));
            console.log('Root level items:', levels['']?.map(item => item.name) || []);

            return levels;
        }

        // Get all excludable items (legacy function for compatibility)
        function getExcludableItems(devices) {
            const tree = buildExcludeTree(devices);
            const itemsByContainer = new Map();

            // Convert tree back to grouped format for backward compatibility
            Object.keys(tree).forEach(containerName => {
                const items = [];

                function collectItems(node, path = '') {
                    Object.keys(node.children).forEach(childKey => {
                        const child = node.children[childKey];
                        items.push({
                            path: child.path,
                            name: childKey,
                            displayName: child.displayName
                        });
                        collectItems(child, child.path);
                    });
                }

                collectItems(tree[containerName]);
                itemsByContainer.set(containerName, items.sort((a, b) => a.displayName.localeCompare(b.displayName)));
            });

            return itemsByContainer;
        }

        // Get all top-level containers from devices (legacy function for compatibility)
        function getTopLevelContainers(devices) {
            const itemsByContainer = getExcludableItems(devices);
            return Array.from(itemsByContainer.keys()).sort();
        }

        // Toggle exclude state for a container
        function toggleContainerExclude(containerName) {
            const dataType = currentTab; // 'niagara' or 'johnson'
            const affectedPaths = getDevicesUnderContainer(containerName, dataType);

            if (excludedContainers.has(containerName)) {
                // Remove container and all its devices
                excludedContainers.delete(containerName);
                affectedPaths.forEach(path => excludedContainers.delete(path));
            } else {
                // Add container and all its devices
                excludedContainers.add(containerName);
                affectedPaths.forEach(path => excludedContainers.add(path));
            }

            // Rebuild templates with current excludes
            rebuildTemplates();

            // Refresh the display
            updateCurrentTabContent();
            updateStats();
            // Update both exclude lists
            updateNiagaraExcludeList();
            updateJohnsonExcludeList();
            saveToLocalStorage();
        }

        // Niagara navigation functions
        function navigateToNiagaraLevel(levelPath) {
            niagaraExcludeLevel = levelPath ? levelPath.split('/') : [];
            updateNiagaraExcludeList();
        }

        function navigateBackNiagara() {
            if (niagaraExcludeLevel.length > 0) {
                niagaraExcludeLevel.pop();
                updateNiagaraExcludeList();
            }
        }

        // Johnson navigation functions
        function navigateToJohnsonLevel(levelPath) {
            johnsonExcludeLevel = levelPath ? levelPath.split('/') : [];
            updateJohnsonExcludeList();
        }

        function navigateBackJohnson() {
            if (johnsonExcludeLevel.length > 0) {
                johnsonExcludeLevel.pop();
                updateJohnsonExcludeList();
            }
        }

        // Update Niagara exclude list UI
        function updateNiagaraExcludeList() {
            const containerEl = document.getElementById('niagaraExcludeList');
            if (!containerEl) return;

            const devices = niagaraData?.devices || [];
            if (devices.length === 0) {
                containerEl.innerHTML = '<p style="color: #666; font-size: 12px; text-align: center;">No devices found. Import a Niagara CSV first.</p>';
                return;
            }

            // Parse devices for drill-down
            const levels = parseDevicesForDrillDown(devices, 'niagara');
            const currentLevelKey = niagaraExcludeLevel.join('/');
            const currentItems = levels[currentLevelKey] || [];

            let html = buildExcludeHTML(currentItems, niagaraExcludeLevel, 'niagara');
            containerEl.innerHTML = html;
        }

        // Update Johnson exclude list UI
        function updateJohnsonExcludeList() {
            const containerEl = document.getElementById('johnsonExcludeList');
            if (!containerEl) return;

            const devices = johnsonData?.devices || [];
            if (devices.length === 0) {
                containerEl.innerHTML = '<p style="color: #666; font-size: 12px; text-align: center;">No devices found. Import a Johnson CSV first.</p>';
                return;
            }

            // Parse devices for drill-down
            const levels = parseDevicesForDrillDown(devices, 'johnson');
            const currentLevelKey = johnsonExcludeLevel.join('/');
            const currentItems = levels[currentLevelKey] || [];

            let html = buildExcludeHTML(currentItems, johnsonExcludeLevel, 'johnson');
            containerEl.innerHTML = html;
        }

        // Build exclude HTML for both tabs
        function buildExcludeHTML(currentItems, currentLevel, dataType) {
            let html = `<div class="exclude-content">`;

            // Add breadcrumb navigation
            html += `<div class="exclude-breadcrumb">
                <button class="breadcrumb-btn" onclick="navigateTo${dataType.charAt(0).toUpperCase() + dataType.slice(1)}Level('')">Root</button>`;

            for (let i = 0; i < currentLevel.length; i++) {
                const levelPath = currentLevel.slice(0, i + 1).join('/');
                html += ` <span class="breadcrumb-separator">></span> <button class="breadcrumb-btn" onclick="navigateTo${dataType.charAt(0).toUpperCase() + dataType.slice(1)}Level('${levelPath}')">${currentLevel[i]}</button>`;
            }
            html += `</div>`;

            // Add back button if not at root
            if (currentLevel.length > 0) {
                html += `
                    <div class="exclude-item back-item">
                        <button class="back-btn" onclick="navigateBack${dataType.charAt(0).toUpperCase() + dataType.slice(1)}()">⬅ Back</button>
                    </div>
                `;
            }

            // Render current level items
            currentItems.forEach(item => {
                const isExcluded = excludedContainers.has(item.fullPath) || excludedContainers.has(item.levelPath);

                html += `
                    <div class="exclude-item">
                        <div class="exclude-item-content">
                            ${item.hasChildren ?
                                `<button class="navigate-btn" onclick="navigateTo${dataType.charAt(0).toUpperCase() + dataType.slice(1)}Level('${item.levelPath}')">${item.displayName} ➤</button>` :
                                `<span class="device-name ${isExcluded ? 'excluded-container' : ''}">${item.displayName}</span>`
                            }
                        </div>
                        <button class="exclude-toggle-btn ${isExcluded ? 'excluded' : ''}"
                                onclick="toggleContainerExclude('${item.levelPath}')">
                            ${isExcluded ? 'Include' : 'Exclude'}
                        </button>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        function getDevicesUnderContainer(containerPath, dataType) {
            const devices = dataType === 'niagara' ? niagaraData.devices : johnsonData.devices;
            const affectedDevices = [];

            if (!devices || devices.length === 0) return affectedDevices;

            devices.forEach(device => {
                // Reconstruct the levelPath for this device using same logic as parseDevicesForDrillDown
                let pathParts = device.path.split('/').filter(p => p);

                // Apply same parsing logic as parseDevicesForDrillDown
                if (dataType === 'johnson') {
                    if (pathParts.length > 0) {
                        const mainPath = pathParts[0];
                        const subParts = mainPath.split('.');
                        pathParts = [...subParts, ...pathParts.slice(1)];
                    }
                } else if (dataType === 'niagara') {
                    if (pathParts.length > 0 && (pathParts[0] === 'Drivers' || pathParts[0] === 'drivers')) {
                        pathParts = pathParts.slice(1);
                    }
                    if (pathParts.length > 2 && (pathParts[0].includes('AML') || pathParts[0].includes('River') || pathParts[1].includes('SNE'))) {
                        pathParts = pathParts.slice(2);
                    }
                    pathParts = pathParts.filter(part => part !== 'points');
                }

                // Check if device belongs to this container
                const containerDepth = containerPath ? containerPath.split('/').length : 0;
                if (containerDepth === 0) {
                    // Root level - include all devices
                    affectedDevices.push(device.path);
                } else {
                    const deviceLevelPath = pathParts.slice(0, containerDepth).join('/');
                    if (deviceLevelPath === containerPath) {
                        affectedDevices.push(device.path);
                    }
                }
            });

            return affectedDevices;
        }

        function rebuildTemplates() {
            // Rebuild Niagara templates if devices exist
            if (niagaraData.devices && niagaraData.devices.length > 0) {
                // Save current settings before rebuilding
                const oldSettings = niagaraData.settings || {};
                const filteredTemplates = findTemplates(niagaraData.devices);
                niagaraData.templates = filteredTemplates;
                // Preserve settings (they are indexed by original template order)
                niagaraData.settings = oldSettings;
            }

            // Rebuild Johnson templates if devices exist
            if (johnsonData.devices && johnsonData.devices.length > 0) {
                // Save current settings before rebuilding
                const oldSettings = johnsonData.settings || {};
                const filteredTemplates = findTemplates(johnsonData.devices);
                johnsonData.templates = filteredTemplates;
                // Preserve settings (they are indexed by original template order)
                johnsonData.settings = oldSettings;
            }
        }

        function findTemplates(devices) {
            // Filter out devices that are in the excluded set
            const activeDevices = devices.filter(device => {
                return !excludedContainers.has(device.path);
            });

            const exact = [];
            const used = new Set();

            activeDevices.forEach(device => {
                if (used.has(device.name)) return;

                const template = {
                    points: device.points,
                    devices: [device]
                };

                used.add(device.name);

                devices.forEach(other => {
                    if (used.has(other.name)) return;
                    if (device.points.length !== other.points.length) return;

                    const match = device.points.every((p, i) =>
                        p.name === other.points[i].name
                    );

                    if (match) {
                        template.devices.push(other);
                        used.add(other.name);
                    }
                });

                exact.push(template);
            });

            // Find partials (simplified - not used in quote generation)
            const partial = [];

            return { exact, partial };
        }

        // Display Name Toggle for Johnson
        function toggleJohnsonDisplayNames() {
            useJohnsonDisplayNames = !useJohnsonDisplayNames;
            const btn = document.getElementById('johnsonDisplayNamesBtn');
            if (useJohnsonDisplayNames) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
            updateDisplay();
            saveToLocalStorage(); // Auto-save after toggle change
        }

        // Helper function for Johnson display names
        function getJohnsonDisplayName(item) {
            return (useJohnsonDisplayNames && item.displayName) ? item.displayName : item.name;
        }

        // Display functions
        function updateDisplay() {
            updateStats();
            updateCurrentTabContent();
            updateExportButton();
        }

        function updateStats() {
            // Safety check for data initialization
            if (!niagaraData || !johnsonData) {
                console.log('Data not yet initialized, skipping stats update');
                return;
            }

            // Count total templates (imported + custom) across both systems
            const totalTemplates = (niagaraData.templates?.exact?.length || 0) + (niagaraData.customTemplates?.length || 0) +
                                  (johnsonData.templates?.exact?.length || 0) + (johnsonData.customTemplates?.length || 0);
            document.getElementById('templateCount').textContent = totalTemplates;

            // Count total equipment across both systems
            const totalEquipment = (niagaraData.devices?.length || 0) + (johnsonData.devices?.length || 0);
            document.getElementById('deviceCount').textContent = totalEquipment;

            // Count configured templates (imported + custom) across both systems
            const niagaraConfigured = Object.values(niagaraData.settings || {}).filter(s =>
                s.name && (s.hours > 0 || (s.type && s.complexity))
            ).length;
            const niagaraCustomConfigured = (niagaraData.customTemplates || []).filter(t =>
                t.name && (t.hours > 0 || (t.type && t.complexity))
            ).length;

            const johnsonConfigured = Object.values(johnsonData.settings || {}).filter(s =>
                s.name && (s.hours > 0 || (s.type && s.complexity))
            ).length;
            const johnsonCustomConfigured = (johnsonData.customTemplates || []).filter(t =>
                t.name && (t.hours > 0 || (t.type && t.complexity))
            ).length;

            const totalConfigured = niagaraConfigured + niagaraCustomConfigured + johnsonConfigured + johnsonCustomConfigured;
            document.getElementById('configuredCount').textContent = totalConfigured;

            const hoursData = calculateTotalHours();
            document.getElementById('baseHours').textContent = hoursData.base.toFixed(1);
            document.getElementById('overheadHours').textContent = hoursData.overhead.toFixed(1);
            document.getElementById('totalHours').textContent = hoursData.total.toFixed(1);
        }

        function calculateTotalHours() {
            let baseTotal = 0;

            // Safety check for data initialization
            if (!niagaraData || !johnsonData) {
                return {
                    base: 0,
                    overhead: 0,
                    total: 0,
                    percentage: 0
                };
            }

            // Niagara imported template hours
            Object.values(niagaraData.settings || {}).forEach((settings, index) => {
                if (settings.name && settings.hours > 0) {
                    const template = niagaraData.templates?.exact?.[index];
                    if (template) {
                        const quantity = settings.customQuantity || template.devices?.length || 0;
                        baseTotal += settings.hours * quantity;
                    }
                }
            });

            // Niagara custom template hours
            (niagaraData.customTemplates || []).forEach(template => {
                if (template.name && template.hours > 0) {
                    baseTotal += template.hours * (template.quantity || 0);
                }
            });

            // Johnson imported template hours
            Object.values(johnsonData.settings || {}).forEach((settings, index) => {
                if (settings.name && settings.hours > 0) {
                    const template = johnsonData.templates?.exact?.[index];
                    if (template) {
                        const quantity = settings.customQuantity || template.devices?.length || 0;
                        baseTotal += settings.hours * quantity;
                    }
                }
            });

            // Johnson custom template hours
            (johnsonData.customTemplates || []).forEach(template => {
                if (template.name && template.hours > 0) {
                    baseTotal += template.hours * (template.quantity || 0);
                }
            });

            // Get overhead percentage from input
            const overheadPercentage = parseFloat(document.getElementById('overheadPercentage').value) || 0;
            const overheadHours = (baseTotal * overheadPercentage) / 100;
            const totalHours = baseTotal + overheadHours;

            return {
                base: baseTotal,
                overhead: overheadHours,
                total: totalHours,
                percentage: overheadPercentage
            };
        }

        function updateCurrentTabContent() {
            if (currentTab === 'niagara') {
                updateNiagaraTemplates();
            } else if (currentTab === 'johnson') {
                updateJohnsonTemplates();
            } else if (currentTab === 'changeOrder') {
                updateChangeOrderTab();
            } else if (currentTab === 'config') {
                updateConfigTab();
            }

            // Update the exclude list based on current tab
            if (currentTab === 'niagara') {
                updateNiagaraExcludeList();
            } else if (currentTab === 'johnson') {
                updateJohnsonExcludeList();
            }
        }

        function updateNiagaraTemplates() {
            const container = document.getElementById('niagaraTemplatesContent');

            // Always show custom template creation section
            let html = `
                <div class="custom-template-section">
                    <div class="custom-template-header">
                        <div class="custom-template-title">
                            <svg class="icon"><use href="#icon-plus"></use></svg>
                            Create Custom Template
                        </div>
                        <button class="custom-template-toggle" onclick="toggleCustomTemplateForm()">
                            + Add Custom Template
                        </button>
                    </div>
                    <div class="custom-template-form" id="customTemplateForm">
                        <div class="template-control-group">
                            <label class="template-control-label">Template Name *</label>
                            <input type="text" class="template-name-input" id="customTemplateName" placeholder="e.g., Home Page" required>
                        </div>
                        <div class="template-control-group">
                            <label class="template-control-label">Type</label>
                            <select class="template-type-select" id="customTemplateType">
                                <option value="">Select Type</option>
                                ${templateTypes.map(type =>
                                    complexityLevels.map(complexity =>
                                        `<option value="${type}|${complexity}">${type} - ${complexity}</option>`
                                    ).join('')
                                ).join('')}
                            </select>
                        </div>
                        <div class="template-control-group">
                            <label class="template-control-label">Quantity *</label>
                            <input type="number" class="template-hours-input" id="customTemplateQuantity" value="1" min="1" required>
                        </div>
                        <div class="template-control-group">
                            <label class="template-control-label">Hours per Unit</label>
                            <input type="number" class="template-hours-input" id="customTemplateHours" placeholder="0.0" step="0.5" min="0">
                        </div>
                        <div class="template-description">
                            <label class="template-control-label">Description (Optional)</label>
                            <textarea id="customTemplateDescription" placeholder="Enter template description..."></textarea>
                        </div>
                        <div class="custom-template-actions">
                            <button class="btn" onclick="toggleCustomTemplateForm()">Cancel</button>
                            <button class="btn primary" onclick="createCustomTemplate()">Create Template</button>
                        </div>
                    </div>
                </div>
            `;

            // Add summary card if we have imported templates
            if (niagaraData.templates.exact.length > 0) {
                const sorted = [...niagaraData.templates.exact].sort((a, b) => b.devices.length - a.devices.length);

                // Calculate filtered device count
                const filteredDeviceCount = niagaraData.devices ? niagaraData.devices.filter(device => {
                    const pathParts = device.path.split('/').filter(p => p);
                    if (pathParts.length === 0) return true;

                    if (excludedContainers.has(device.path)) return false;

                    let topLevel = pathParts[0];
                    if (pathParts.length > 2 && (pathParts[0].includes('AML') || pathParts[0].includes('River') || pathParts[1].includes('SNE'))) {
                        topLevel = pathParts[2] || pathParts[1] || pathParts[0];
                    }

                    return !excludedContainers.has(topLevel);
                }).length : 0;

                html += `
                    <div class="summary-card">
                        <h2>📋 Imported Templates</h2>
                        <div class="summary-stats">
                            <div class="stat">
                                <div class="stat-value">${sorted.length}</div>
                                <div class="stat-label">Unique Templates</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${filteredDeviceCount}</div>
                                <div class="stat-label">Total Equipment</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${sorted.length > 0 ? (filteredDeviceCount / sorted.length).toFixed(1) : '0'}</div>
                                <div class="stat-label">Avg per Template</div>
                            </div>
                        </div>
                    </div>
                `;

                // Add imported templates
                sorted.forEach((template, i) => {
                    const originalIndex = niagaraData.templates.exact.indexOf(template);
                    const settings = niagaraData.settings[originalIndex] || {};
                    const percent = filteredDeviceCount > 0 ? ((template.devices.length / filteredDeviceCount) * 100).toFixed(1) : '0';

                    html += generateTemplateCard('niagara', template, originalIndex, settings, percent, originalIndex + 1);
                });
            }

            // Add custom templates
            if (niagaraData.customTemplates && niagaraData.customTemplates.length > 0) {
                niagaraData.customTemplates.forEach(template => {
                    html += generateCustomTemplateCard('niagara', template);
                });
            }

            container.innerHTML = html;
        }

        function updateJohnsonTemplates() {
            const container = document.getElementById('johnsonTemplatesContent');

            // Always show custom template creation section
            let html = `
                <div class="custom-template-section">
                    <div class="custom-template-header">
                        <div class="custom-template-title">
                            <h3>Create Custom Template</h3>
                            <p>Add equipment templates not automatically detected from the CSV import.</p>
                        </div>
                        <button class="btn outline" onclick="toggleCustomTemplateForm()" id="customTemplateToggle">
                            <svg class="icon"><use href="#icon-plus"></use></svg>
                            Add Custom Template
                        </button>
                    </div>
                    <div class="custom-template-form" id="customTemplateForm" style="display: none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Template Name</label>
                                <input type="text" id="customTemplateName" placeholder="e.g. VAV Box Controller">
                            </div>
                            <div class="form-group">
                                <label>Type & Complexity</label>
                                <select id="customTemplateTypeComplexity">
                                    <option value="">Select type and complexity</option>
                                    <option value="Air Systems|Basic">Air Systems - Basic</option>
                                    <option value="Air Systems|Standard">Air Systems - Standard</option>
                                    <option value="Air Systems|Complex">Air Systems - Complex</option>
                                    <option value="Water Systems|Basic">Water Systems - Basic</option>
                                    <option value="Water Systems|Standard">Water Systems - Standard</option>
                                    <option value="Water Systems|Complex">Water Systems - Complex</option>
                                    <option value="Lighting|Basic">Lighting - Basic</option>
                                    <option value="Lighting|Standard">Lighting - Standard</option>
                                    <option value="Security|Basic">Security - Basic</option>
                                    <option value="Security|Standard">Security - Standard</option>
                                    <option value="Fire/Life Safety|Basic">Fire/Life Safety - Basic</option>
                                    <option value="Fire/Life Safety|Standard">Fire/Life Safety - Standard</option>
                                    <option value="Electrical|Basic">Electrical - Basic</option>
                                    <option value="Electrical|Standard">Electrical - Standard</option>
                                    <option value="Specialty Equipment|Basic">Specialty Equipment - Basic</option>
                                    <option value="Specialty Equipment|Standard">Specialty Equipment - Standard</option>
                                    <option value="Specialty Equipment|Complex">Specialty Equipment - Complex</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Quantity</label>
                                <input type="number" id="customTemplateQuantity" min="1" value="1">
                            </div>
                            <div class="form-group">
                                <label>Hours per Unit</label>
                                <input type="number" id="customTemplateHours" step="0.1" min="0" placeholder="0.0">
                            </div>
                            <div class="form-group full-width">
                                <label>Description (Optional)</label>
                                <textarea id="customTemplateDescription" placeholder="Additional details about this template..."></textarea>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn outline" onclick="toggleCustomTemplateForm()">Cancel</button>
                            <button class="btn primary" onclick="createCustomTemplate()">Create Template</button>
                        </div>
                    </div>
                </div>
            `;

            // Add summary card if we have imported templates
            if (johnsonData.templates.exact.length > 0) {
                const sorted = [...johnsonData.templates.exact].sort((a, b) => b.devices.length - a.devices.length);

                // Calculate filtered device count
                const filteredDeviceCount = johnsonData.devices ? johnsonData.devices.filter(device => {
                    const pathParts = device.path.split('/').filter(p => p);
                    if (pathParts.length === 0) return true;

                    if (excludedContainers.has(device.path)) return false;

                    let topLevel = pathParts[0];
                    if (pathParts.length > 2 && (pathParts[0].includes('AML') || pathParts[0].includes('River') || pathParts[1].includes('SNE'))) {
                        topLevel = pathParts[2] || pathParts[1] || pathParts[0];
                    }

                    return !excludedContainers.has(topLevel);
                }).length : 0;
                html += `
                    <div class="summary-card">
                        <h2>📋 Imported Templates</h2>
                        <div class="summary-stats">
                            <div class="stat">
                                <div class="stat-value">${sorted.length}</div>
                                <div class="stat-label">Templates Found</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${filteredDeviceCount}</div>
                                <div class="stat-label">Total Equipment</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${sorted.length > 0 ? (filteredDeviceCount / sorted.length).toFixed(1) : '0'}</div>
                                <div class="stat-label">Avg per Template</div>
                            </div>
                        </div>
                    </div>
                `;

                // Add imported templates
                sorted.forEach((template, i) => {
                    const originalIndex = johnsonData.templates.exact.indexOf(template);
                    const settings = johnsonData.settings[originalIndex] || {};
                    const percent = filteredDeviceCount > 0 ? ((template.devices.length / filteredDeviceCount) * 100).toFixed(1) : '0';

                    html += generateTemplateCard('johnson', template, originalIndex, settings, percent, originalIndex + 1);
                });
            }

            // Add custom templates
            if (johnsonData.customTemplates && johnsonData.customTemplates.length > 0) {
                johnsonData.customTemplates.forEach(template => {
                    html += generateCustomTemplateCard('johnson', template);
                });
            }

            container.innerHTML = html;
        }

        function generateTemplateCard(system, template, originalIndex, settings, percent, displayIndex) {
            return `
                <div class="template-card">
                    <div class="template-header">
                        <span class="template-title">Template ${displayIndex}</span>
                        <span class="template-count">${template.devices.length} devices (${percent}%)</span>
                    </div>

                    <div class="template-controls">
                        <div class="template-control-group">
                            <label class="template-control-label">Template Name</label>
                            <input type="text" class="template-name-input"
                                   placeholder="Template ${displayIndex}"
                                   value="${settings.name || ''}"
                                   onchange="updateTemplateName('${system}', ${originalIndex}, this.value)">
                        </div>

                        <div class="template-control-group">
                            <label class="template-control-label">Type</label>
                            <select class="template-type-select"
                                    onchange="updateTemplateTypeAndComplexity('${system}', ${originalIndex}, this.value)">
                                <option value="">Select Type</option>
                                ${templateTypes.map(type =>
                                    complexityLevels.map(complexity =>
                                        `<option value="${type}|${complexity}" ${settings.type === type && settings.complexity === complexity ? 'selected' : ''}>
                                            ${type} - ${complexity}
                                        </option>`
                                    ).join('')
                                ).join('')}
                            </select>
                        </div>

                        <div class="template-control-group">
                            <label class="template-control-label">Hours</label>
                            <input type="number" class="template-hours-input"
                                   placeholder="0.0" step="0.5" min="0"
                                   value="${settings.hours || ''}"
                                   data-template="${originalIndex}" data-field="hours"
                                   onchange="updateTemplateHours('${system}', ${originalIndex}, this.value)">
                        </div>

                        <div class="template-control-group">
                            <label class="template-control-label">Custom Quantity</label>
                            <input type="number" class="template-hours-input"
                                   placeholder="${template.devices.length}" min="1"
                                   value="${settings.customQuantity || ''}"
                                   onchange="updateTemplateQuantity('${system}', ${originalIndex}, this.value)">
                        </div>

                        <div class="template-description">
                            <label class="template-control-label">Description (Optional)</label>
                            <textarea placeholder="Enter template description..."
                                      onchange="updateTemplateDescription('${system}', ${originalIndex}, this.value)">${settings.description || ''}</textarea>
                        </div>
                    </div>

                    <div class="device-grid">
                        ${template.devices.map(d => `<div class="device-item" title="${d.path}">${system === 'johnson' ? getJohnsonDisplayName(d) : d.name}</div>`).join('')}
                    </div>

                    <div class="points-summary">
                        <div class="points-header">
                            <strong>${template.points.length} Points:</strong>
                            ${template.points.length > 8 ? `<button class="expand-points-btn" data-template="${displayIndex}" onclick="togglePoints(${displayIndex})">▶</button>` : ''}
                        </div>
                        <div class="points-preview" id="points-preview-${displayIndex}">
                            ${template.points.slice(0, 8).map(p => system === 'johnson' ? getJohnsonDisplayName(p) : p.name).join(', ')}
                            ${template.points.length > 8 ? '...' : ''}
                        </div>
                        <div class="points-expanded" id="points-expanded-${displayIndex}" style="display: none;">
                            ${template.points.map(p =>
                                `<div class="template-point-item" title="Point: ${p.name}">• ${system === 'johnson' ? getJohnsonDisplayName(p) : p.name}</div>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function updateTemplateTypeAndComplexity(system, index, value) {
            if (!value) return;

            const [type, complexity] = value.split('|');
            updateTemplateType(system, index, type, complexity);
        }

        function updateConfigTab() {
            const container = document.getElementById('configGrid');

            let html = '';
            templateTypes.forEach(type => {
                complexityLevels.forEach(complexity => {
                    const key = `${type}_${complexity}`;
                    const currentValue = defaultHours[type] && defaultHours[type][complexity] ? defaultHours[type][complexity] : 0.5;

                    html += `
                        <div class="config-item">
                            <span class="config-item-label">${type} - ${complexity}</span>
                            <input type="number" class="config-item-input"
                                   value="${currentValue}"
                                   step="0.5" min="0"
                                   onchange="updateDefaultHours('${type}', '${complexity}', this.value)">
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
        }

        function updateDefaultHours(type, complexity, hours) {
            if (!defaultHours[type]) defaultHours[type] = {};
            defaultHours[type][complexity] = parseFloat(hours) || 0;
        }

        // Project Settings Helper Functions
        function getProjectName() {
            const customName = document.getElementById('projectName').value.trim();
            if (customName) return customName;

            // Try to get from loaded CSV filename
            const currentFile = document.getElementById('currentProject').textContent;
            if (currentFile && currentFile !== 'None') {
                return currentFile.replace(/\.csv$/i, '');
            }

            return 'Untitled Project';
        }

        function getCreatedBy() {
            const createdBy = document.getElementById('createdBy').value.trim();
            return createdBy || 'Quote Tool';
        }

        function getPONumber() {
            const poNumber = document.getElementById('poNumber').value.trim();
            return poNumber || '';
        }

        function updateProjectName(filename) {
            // Auto-fill project name when CSV is loaded (only if empty)
            const projectInput = document.getElementById('projectName');
            if (!projectInput.value.trim()) {
                projectInput.value = filename.replace(/\.csv$/i, '');
            }
        }

        function sanitizeFilename(name) {
            // Remove invalid filename characters
            return name.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_');
        }

        function togglePoints(templateIndex) {
            const previewEl = document.getElementById(`points-preview-${templateIndex}`);
            const expandedEl = document.getElementById(`points-expanded-${templateIndex}`);
            const buttonEl = document.querySelector(`[data-template="${templateIndex}"]`);

            if (expandedEl.style.display === 'none') {
                // Expand
                previewEl.style.display = 'none';
                expandedEl.style.display = 'grid';
                buttonEl.textContent = '▼';
            } else {
                // Collapse
                previewEl.style.display = 'block';
                expandedEl.style.display = 'none';
                buttonEl.textContent = '▶';
            }
        }

        function updateExportButton() {
            const exportBtn = document.getElementById('exportQuoteBtn');
            const scopeBtn = document.getElementById('exportScopeBtn');
            if (hasConfiguredTemplates()) {
                exportBtn.style.display = 'inline-flex';
                scopeBtn.style.display = 'inline-flex';
            } else {
                exportBtn.style.display = 'none';
                scopeBtn.style.display = 'none';
            }
        }

        // Tab navigation
        function showTab(event, tabName) {
            currentTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');

            updateCurrentTabContent();
        }

        // Quote export functionality
        async function exportQuote() {
            const quote = generateQuote();

            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${getProjectName()} - Quote</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 0;
                            padding: 40px;
                            line-height: 1.4;
                            color: #333;
                            font-size: 14px;
                        }
                        .header-bar {
                            background: #0066cc;
                            color: white;
                            padding: 20px;
                            margin: -40px -40px 30px -40px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 15px;
                            min-height: 60px;
                        }
                        .logo {
                            height: 30px;
                            width: auto;
                            flex-shrink: 0;
                        }
                        .header-title {
                            font-size: 24px;
                            font-weight: bold;
                            margin: 0;
                        }
                        .header-info {
                            margin-bottom: 20px;
                            line-height: 1.5;
                            font-size: 14px;
                        }
                        .header-info p {
                            margin: 3px 0;
                        }
                        .summary {
                            background: #e8f4fd;
                            padding: 15px;
                            border-radius: 6px;
                            margin-bottom: 20px;
                            page-break-inside: avoid;
                        }
                        .summary h3 {
                            color: #2c3e50;
                            margin-top: 0;
                            margin-bottom: 10px;
                            font-size: 16px;
                        }
                        .summary-item {
                            margin: 5px 0;
                            font-weight: 500;
                            font-size: 14px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                            page-break-inside: avoid;
                        }
                        th, td {
                            padding: 8px;
                            text-align: left;
                            border-bottom: 1px solid #ddd;
                            font-size: 13px;
                        }
                        th {
                            background-color: #f2f2f2;
                            font-weight: bold;
                        }
                        .template-item {
                            margin: 15px 0;
                            padding: 12px;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            background: #fafafa;
                            page-break-inside: avoid;
                        }
                        .template-header {
                            font-size: 16px;
                            font-weight: bold;
                            color: #2c3e50;
                            margin-bottom: 8px;
                        }
                        .template-details {
                            margin: 8px 0;
                            line-height: 1.4;
                            font-size: 13px;
                        }
                        .equipment-grid {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 4px;
                            margin-top: 8px;
                        }
                        .equipment-item {
                            background: #f8f9fa;
                            padding: 6px 10px;
                            border-radius: 3px;
                            font-size: 12px;
                            color: #555;
                            border-left: 2px solid #0066cc;
                            flex: 0 0 auto;
                            max-width: 200px;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                        }
                        .equipment-item::before {
                            content: "•";
                            margin-right: 4px;
                            color: #0066cc;
                            font-weight: bold;
                        }
                        .description {
                            font-style: italic;
                            color: #666;
                            margin-top: 4px;
                            font-size: 13px;
                        }
                        h2 {
                            color: #2c3e50;
                            border-bottom: 2px solid #0066cc;
                            padding-bottom: 4px;
                            font-size: 20px;
                            page-break-after: avoid;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            .template-item {
                                page-break-inside: avoid;
                                break-inside: avoid;
                            }
                            .header-bar {
                                page-break-after: avoid;
                                break-after: avoid;
                            }
                            .summary {
                                page-break-after: avoid;
                                break-after: avoid;
                            }
                            h2 {
                                page-break-after: avoid;
                                break-after: avoid;
                            }
                        }
                        @page {
                            margin: 0.75in;
                            size: letter;
                        }
                    </style>
                </head>
                <body>
                    <div class="header-bar">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAATIAAAByCAMAAADnN60vAAAAKlBMVEVHcEz///////////////////////////////////////////////////+LBpLMAAAADXRSTlMAQr+B2ZgQ7yBgMK9wl984bwAABjhJREFUeNrtXd1ytSoMJYHwp3n/1z2floKboqOmzpmC66ajmyhGwlpBoOrFixcvXrx48eL/AOBNzGpUGL4JrwZF4JvQSqkhG5p1fA/GKgU8os+IbyIopZCdVaPB801gimlSowH5JuA7pqMaC8B3kBqXTs1tLBi+B2dLTIMaCbNAYOSYNmog3BcYHzGt1Tggvgn4iGk3ThoQJQJDc8JQQgP5JnyO6cEYAAR9f4npkYSGlQgM+JE9jQAtSy4/YUZINb0TJZcJQwkNEiWXI443ipPLGpPqHShLLhNGEhqi0euJPzBGqilMLpvofExb8x7w9oBR32PanncRr8b0IKnmJHlqP+KHTTjgw6tRPUiqaXgP83nuGEpozLwHc0GhjCQ05I2kNNNBUk2Sd0XAPJLQ+BXCo6GEBvIeSDxy1OfH8zMx9QqNkz13uHadYYSGFumDttDoe0z7F1UoDiI0iPcwib8b9/nxPJ4QGK/QuBdMb6r5TJc99y807IHAkAqWTj+en5afb6qZ4H+/75k6FxqXGW74MW040FHSWO/04/kjw4K251TzssAYfkzbuocEATJ3+vHcwi6UCLF3ofE3iLh3WNerNjsOTLgJvwiNXoca8bD7J8EEPWU6zTOPu2nrBNNAodfRDDpeVs83EZcW3KeUVdYd5oNGMKXd90qXx/kgSBZO6F7H/4/zwUnAANb1JjAS4DAf9CxggNBbgnkuH9QSBjDd9f1f8BKhccwA0JvAOJcPBgkDUKezf6RC4yA18q4zgXHi06N0GbDuddTnWGiQZCcz08vY4jWhIWKAvy0wgBBnf/3To5ZsnIFtgeHJMLObtueD/odGtSe3LRp0BuzY5gKz/z4OpVgqsL24IZ99tN6M4nJgJ2Y0zOG60JAwQOQFuMvSaPNJ1+JVi1VR5AITm7Z1VpsqkIxTgc96uJCPC+FPbOAfHMOlVJN+ZSMIX3msNegILWK1pi6K/MO4tq3qv+8yqkTR/HEcGfX6XthcneMk326EGn2nCQCUHzT3Dq7RZSCkojrVhbTWZDKr1LbL1bXW6FIV2i5LmhMDzCaNGSwGGgDWY6UZNCtiNbG/9OkRpZvazD8EhsmOCqUJ2p9pVbpxyEVdemrIoYEt2+V8bqJhx2WlHqngrCAdp5usLmM2i+9ujGlLGMCE+vWUiKIP761HdQTjxtFx6zKff6xsl/PZqXrXZVDqEdcisBTPu+qG1WXIURHDRaFhhWuofaPjnDfNCHNsWVNpXlM3u+SyXOWpst1zmYEVZusyvXlBABDXCzrty6slzZ5JGb4zpq0lDKD2HnrTE/v1+SnHYfl1x9pCCrvKtg5M+KCD4rKqHoV32dDsUwdPqDQi04WZZmUwVR9i4n3jpsvs9iBlbQtJVdODvkVwxC/EqgchVdlmq0wQ/oLLQomO8NWMCWZkY5+Y42ROGxcvlYN0AZv/1C6D0jViFfYN28qp512m4vRJe7iGqn1kOQ3wWeNc1RILObZUHZmL/YHLmFRte0HKYqtyNpDZZsXgb6aaklG32rg8msXoU4GVzRHRfBq4pEH8EmfFZbCcmpM/f9oys8MFOqoDl1HyS8mpEnwwyeT5HXjb0A0NiKl3xtQSTHt+6LQx37os/wgt2+p52y7L9SjEHRAxZmmPj27DaM7OIS3CMxTCCfWd5w/vulgqB7WUhYbtOZflepRXM5cXZJjx2b245sM2OrVuo70Ct/o7ndGwYP6MTJOkkg2u7bKG7TmXlXqkTt+r+P0ofjkxPbvrj7NX5sNbUzt0MbWl+4rt/rXtstr2pMvqeuj6rcPDGxfThWWdtc8o6/iSQmUEl107NVw2N2xPu0xFUypR1ys8/v834NruJPqrrCNaHDojImz+aQqpAk9fJbUKa+dMiBhzSWzZVlcox6vx14mUz+sk+EF9HPMEz++Th1enyPo084+MPTNz8NFpiV4VxOpuDwqNcHeK7J//9OT5NgN0vkhiHyRhAOh3kcQTQmOVBlO3iySOECQMYN2QiySMhAHmIRdJgIQBFA608U/BJGGA2P96/Aa8iAF09+vxW9ASBlBmRAawIgaAIRkgiBiAhmQAlDCAdSMyALCEAWBIBiARA+CQDKDvwi8ypdtVvy9evHjxYjT8B5GvsSxWBvj8AAAAAElFTkSuQmCC" alt="QAG Logo" class="logo">
                        <h1 class="header-title">Quote</h1>
                    </div>

                    <div class="header-info">
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                        <p><strong>Project:</strong> ${getProjectName()}</p>
                        ${getPONumber() ? `<p><strong>PO#:</strong> ${getPONumber()}</p>` : ''}
                        <p><strong>Generated by:</strong> ${getCreatedBy()}</p>
                    </div>

                    <div class="summary">
                        <h3>Project Summary</h3>
                        <div class="summary-item"><strong>Total Equipment:</strong> ${quote.totalEquipment} units</div>
                        <div class="summary-item"><strong>Total Data Points:</strong> ${quote.totalPoints}</div>
                        <div class="summary-item"><strong>Base Labor Hours:</strong> ${quote.baseHours.toFixed(1)}</div>
                        ${quote.overheadPercentage > 0 ? `<div class="summary-item"><strong>Overhead (${quote.overheadPercentage}%):</strong> ${quote.overheadHours.toFixed(1)} hours</div>` : ''}
                        <div class="summary-item"><strong>Total Labor Hours:</strong> ${quote.totalHours.toFixed(1)}</div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Template</th>
                                <th>Type</th>
                                <th>Units</th>
                                <th>Points/Unit</th>
                                <th>Hours/Unit</th>
                                <th>Total Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${quote.templates.map(t => `
                                <tr>
                                    <td>${t.name}</td>
                                    <td>${(t.type && t.complexity) ? `${t.type} - ${t.complexity}` : 'Custom'}</td>
                                    <td>${t.deviceCount}</td>
                                    <td>${t.pointCount}</td>
                                    <td>${t.hoursPerUnit}</td>
                                    <td>${t.totalHours}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <h2>Template Details</h2>
                    ${quote.templates.map(t => `
                        <div class="template-item">
                            <div class="template-header">${t.name}</div>
                            ${t.description ? `<div class="description">${t.description}</div>` : ''}
                            <div class="template-details">
                                <strong>Type:</strong> ${t.type || 'Not specified'}<br>
                                <strong>Complexity:</strong> ${t.complexity || 'Not specified'}<br>
                                <strong>Equipment Count:</strong> ${t.deviceCount} units<br>
                                <strong>Points per unit:</strong> ${t.pointCount}<br>
                                <strong>Hours per unit:</strong> ${t.hoursPerUnit}<br>
                                <strong>Total hours:</strong> ${t.totalHours}
                            </div>
                            <div style="margin-top: 15px;">
                                <strong>Equipment:</strong>
                                <div class="equipment-grid">
                                    ${t.devices.map(device => `<div class="equipment-item">${device}</div>`).join('')}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </body>
                </html>
            `;

            // Open HTML in new tab
            const newWindow = window.open('', '_blank');
            newWindow.document.write(html);
            newWindow.document.close();

            showToast('Quote opened in new tab - use Ctrl+P or Cmd+P to print/save as PDF');
        }

        // Scope of Work export functionality
        async function exportScopeOfWork() {
            const scope = generateScopeOfWork();

            const logoBase64 = 'data:image/png;base64,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';

            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${getProjectName()} - Scope of Work</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: Arial, sans-serif;
                            margin: 0;
                            padding: 40px;
                            line-height: 1.4;
                            color: #333;
                            font-size: 14px;
                        }
                        .header-bar {
                            background: #0066cc;
                            color: white;
                            padding: 20px;
                            margin: -40px -40px 30px -40px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 15px;
                            min-height: 60px;
                        }
                        .logo {
                            height: 30px;
                            width: auto;
                            flex-shrink: 0;
                        }
                        .header-title {
                            font-size: 24px;
                            font-weight: bold;
                            margin: 0;
                        }
                        .project-info {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                            gap: 12px;
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 6px;
                            margin-bottom: 20px;
                            page-break-inside: avoid;
                        }
                        .info-item {
                            display: flex;
                            flex-direction: column;
                        }
                        .info-label {
                            font-weight: 600;
                            color: #666;
                            font-size: 13px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 3px;
                        }
                        .info-value {
                            font-size: 13px;
                            color: #333;
                        }
                        .summary-section {
                            background: #e8f4fd;
                            padding: 25px;
                            border-radius: 8px;
                            margin-bottom: 30px;
                            border-left: 4px solid #0066cc;
                        }
                        .summary-section h2 {
                            color: #0066cc;
                            margin-bottom: 15px;
                            font-size: 20px;
                        }
                        .summary-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                            gap: 15px;
                            margin-top: 15px;
                        }
                        .summary-item {
                            text-align: center;
                            background: white;
                            padding: 15px;
                            border-radius: 6px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        }
                        .summary-value {
                            display: block;
                            font-size: 24px;
                            font-weight: 700;
                            color: #0066cc;
                            margin-bottom: 5px;
                        }
                        .summary-label {
                            font-size: 14px;
                            color: #666;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        .templates-section h2 {
                            color: #333;
                            margin-bottom: 20px;
                            font-size: 20px;
                            padding-bottom: 10px;
                            border-bottom: 2px solid #e9ecef;
                        }
                        .template-card {
                            background: white;
                            border: 1px solid #e9ecef;
                            border-radius: 8px;
                            margin-bottom: 20px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                            overflow: hidden;
                        }
                        .template-header {
                            background: #f8f9fa;
                            padding: 15px 20px;
                            border-bottom: 1px solid #e9ecef;
                        }
                        .template-name {
                            font-size: 18px;
                            font-weight: 600;
                            color: #333;
                            margin-bottom: 5px;
                        }
                        .template-description {
                            font-style: italic;
                            color: #666;
                            font-size: 14px;
                        }
                        .template-body {
                            padding: 20px;
                        }
                        .template-details {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                            gap: 15px;
                            margin-bottom: 20px;
                        }
                        .detail-item {
                            display: flex;
                            flex-direction: column;
                        }
                        .detail-label {
                            font-weight: 600;
                            color: #666;
                            font-size: 14px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 4px;
                        }
                        .detail-value {
                            font-size: 16px;
                            color: #333;
                        }
                        .equipment-section {
                            margin-top: 20px;
                        }
                        .equipment-label {
                            font-weight: 600;
                            color: #333;
                            margin-bottom: 10px;
                            font-size: 14px;
                        }
                        .equipment-grid {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 4px;
                            margin-top: 8px;
                        }
                        .equipment-item {
                            background: #f8f9fa;
                            padding: 6px 10px;
                            border-radius: 3px;
                            font-size: 12px;
                            color: #555;
                            border-left: 2px solid #0066cc;
                            flex: 0 0 auto;
                            max-width: 200px;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                        }
                        .equipment-item::before {
                            content: "•";
                            margin-right: 4px;
                            color: #0066cc;
                            font-weight: bold;
                        }
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                            .template-card {
                                page-break-inside: avoid;
                                break-inside: avoid;
                            }
                            .header-bar {
                                page-break-after: avoid;
                                break-after: avoid;
                            }
                            .summary-section {
                                page-break-after: avoid;
                                break-after: avoid;
                            }
                            h2 {
                                page-break-after: avoid;
                                break-after: avoid;
                            }
                        }
                        @page {
                            margin: 0.75in;
                            size: letter;
                        }
                    </style>
                </head>
                <body>
                    <div class="header-bar">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAATIAAAByCAMAAADnN60vAAAAKlBMVEVHcEz///////////////////////////////////////////////////+LBpLMAAAADXRSTlMAQr+B2ZgQ7yBgMK9wl984bwAABjhJREFUeNrtXd1ytSoMJYHwp3n/1z2floKboqOmzpmC66ajmyhGwlpBoOrFixcvXrx48eL/AOBNzGpUGL4JrwZF4JvQSqkhG5p1fA/GKgU8os+IbyIopZCdVaPB801gimlSowH5JuA7pqMaC8B3kBqXTs1tLBi+B2dLTIMaCbNAYOSYNmog3BcYHzGt1Tggvgn4iGk3ThoQJQJDc8JQQgP5JnyO6cEYAAR9f4npkYSGlQgM+JE9jQAtSy4/YUZINb0TJZcJQwkNEiWXI443ipPLGpPqHShLLhNGEhqi0euJPzBGqilMLpvofExb8x7w9oBR32PanncRr8b0IKnmJHlqP+KHTTjgw6tRPUiqaXgP83nuGEpozLwHc0GhjCQ05I2kNNNBUk2Sd0XAPJLQ+BXCo6GEBvIeSDxy1OfH8zMx9QqNkz13uHadYYSGFumDttDoe0z7F1UoDiI0iPcwib8b9/nxPJ4QGK/QuBdMb6r5TJc99y807IHAkAqWTj+en5afb6qZ4H+/75k6FxqXGW74MW040FHSWO/04/kjw4K251TzssAYfkzbuocEATJ3+vHcwi6UCLF3ofE3iLh3WNerNjsOTLgJvwiNXoca8bD7J8EEPWU6zTOPu2nrBNNAodfRDDpeVs83EZcW3KeUVdYd5oNGMKXd90qXx/kgSBZO6F7H/4/zwUnAANb1JjAS4DAf9CxggNBbgnkuH9QSBjDd9f1f8BKhccwA0JvAOJcPBgkDUKezf6RC4yA18q4zgXHi06N0GbDuddTnWGiQZCcz08vY4jWhIWKAvy0wgBBnf/3To5ZsnIFtgeHJMLObtueD/odGtSe3LRp0BuzY5gKz/z4OpVgqsL24IZ99tN6M4nJgJ2Y0zOG60JAwQOQFuMvSaPNJ1+JVi1VR5AITm7Z1VpsqkIxTgc96uJCPC+FPbOAfHMOlVJN+ZSMIX3msNegILWK1pi6K/MO4tq3qv+8yqkTR/HEcGfX6XthcneMk326EGn2nCQCUHzT3Dq7RZSCkojrVhbTWZDKr1LbL1bXW6FIV2i5LmhMDzCaNGSwGGgDWY6UZNCtiNbG/9OkRpZvazD8EhsmOCqUJ2p9pVbpxyEVdemrIoYEt2+V8bqJhx2WlHqngrCAdp5usLmM2i+9ujGlLGMCE+vWUiKIP761HdQTjxtFx6zKff6xsl/PZqXrXZVDqEdcisBTPu+qG1WXIURHDRaFhhWuofaPjnDfNCHNsWVNpXlM3u+SyXOWpst1zmYEVZusyvXlBABDXCzrty6slzZ5JGb4zpq0lDKD2HnrTE/v1+SnHYfl1x9pCCrvKtg5M+KCD4rKqHoV32dDsUwdPqDQi04WZZmUwVR9i4n3jpsvs9iBlbQtJVdODvkVwxC/EqgchVdlmq0wQ/oLLQomO8NWMCWZkY5+Y42ROGxcvlYN0AZv/1C6D0jViFfYN28qp512m4vRJe7iGqn1kOQ3wWeNc1RILObZUHZmL/YHLmFRte0HKYqtyNpDZZsXgb6aaklG32rg8msXoU4GVzRHRfBq4pEH8EmfFZbCcmpM/f9oys8MFOqoDl1HyS8mpEnwwyeT5HXjb0A0NiKl3xtQSTHt+6LQx37os/wgt2+p52y7L9SjEHRAxZmmPj27DaM7OIS3CMxTCCfWd5w/vulgqB7WUhYbtOZflepRXM5cXZJjx2b245sM2OrVuo70Ct/o7ndGwYP6MTJOkkg2u7bKG7TmXlXqkTt+r+P0ofjkxPbvrj7NX5sNbUzt0MbWl+4rt/rXtstr2pMvqeuj6rcPDGxfThWWdtc8o6/iSQmUEl107NVw2N2xPu0xFUypR1ys8/v834NruJPqrrCNaHDojImz+aQqpAk9fJbUKa+dMiBhzSWzZVlcox6vx14mUz+sk+EF9HPMEz++Th1enyPo084+MPTNz8NFpiV4VxOpuDwqNcHeK7J//9OT5NgN0vkhiHyRhAOh3kcQTQmOVBlO3iySOECQMYN2QiySMhAHmIRdJgIQBFA608U/BJGGA2P96/Aa8iAF09+vxW9ASBlBmRAawIgaAIRkgiBiAhmQAlDCAdSMyALCEAWBIBiARA+CQDKDvwi8ypdtVvy9evHjxYjT8B5GvsSxWBvj8AAAAAElFTkSuQmCC" alt="QAG Logo" class="logo">
                        <h1 class="header-title">Scope of Work</h1>
                    </div>

                    <div class="project-info">
                        <div class="info-item">
                            <span class="info-label">Date</span>
                            <span class="info-value">${new Date().toLocaleDateString()}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Project</span>
                            <span class="info-value">${getProjectName()}</span>
                        </div>
                        ${getPONumber() ? `
                        <div class="info-item">
                            <span class="info-label">PO Number</span>
                            <span class="info-value">${getPONumber()}</span>
                        </div>
                        ` : ''}
                        <div class="info-item">
                            <span class="info-label">Generated By</span>
                            <span class="info-value">${getCreatedBy()}</span>
                        </div>
                    </div>

                    <div class="summary-section">
                        <h2>Project Summary</h2>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <span class="summary-value">${scope.totalTemplates}</span>
                                <span class="summary-label">Templates</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-value">${scope.totalDevices}</span>
                                <span class="summary-label">Total Devices</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-value">${scope.totalPoints}</span>
                                <span class="summary-label">Total Points</span>
                            </div>
                        </div>
                    </div>

                    <div class="templates-section">
                        <h2>Equipment Templates</h2>
                        ${scope.templates.map(t => `
                            <div class="template-card">
                                <div class="template-header">
                                    <div class="template-name">${t.name}</div>
                                    ${t.description ? `<div class="template-description">${t.description}</div>` : ''}
                                </div>
                                <div class="template-body">
                                    <div class="template-details">
                                        <div class="detail-item">
                                            <span class="detail-label">Type</span>
                                            <span class="detail-value">${t.type || 'Equipment Template'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Equipment Count</span>
                                            <span class="detail-value">${t.deviceCount} units</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Points per Unit</span>
                                            <span class="detail-value">${t.pointCount}</span>
                                        </div>
                                    </div>
                                    <div class="equipment-section">
                                        <div class="equipment-label">Equipment:</div>
                                        <div class="equipment-grid">
                                            ${t.devices.map(device => `<div class="equipment-item">${device}</div>`).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </body>
                </html>
            `;

            // Open HTML in new tab
            const newWindow = window.open('', '_blank');
            newWindow.document.write(html);
            newWindow.document.close();

            showToast('Scope of Work opened in new tab - use Ctrl+P or Cmd+P to print/save as PDF');
        }

        function generateQuote() {
            const templates = [];

            // Collect Niagara templates
            Object.entries(niagaraData.settings).forEach(([templateIndex, settings]) => {
                if (settings.name && (settings.hours > 0 || (settings.type && settings.complexity))) {
                    const template = niagaraData.templates.exact[templateIndex];
                    if (template) {
                        const quantity = settings.customQuantity || template.devices.length;
                        let hours = settings.hours;

                        // If no manual hours but type/complexity set, use defaults
                        if (!hours && settings.type && settings.complexity && defaultHours[settings.type] && defaultHours[settings.type][settings.complexity]) {
                            hours = defaultHours[settings.type][settings.complexity];
                        }

                        templates.push({
                            name: settings.name,
                            type: settings.type,
                            complexity: settings.complexity,
                            description: settings.description,
                            hoursPerUnit: hours || 0,
                            deviceCount: quantity,
                            pointCount: template.points.length,
                            totalHours: (hours || 0) * quantity,
                            devices: template.devices.map(d => d.name),
                            system: 'Niagara'
                        });
                    }
                }
            });

            // Collect Niagara custom templates
            niagaraData.customTemplates.forEach(template => {
                if (template.name && (template.hours > 0 || (template.type && template.complexity))) {
                    let hours = template.hours;

                    // If no manual hours but type/complexity set, use defaults
                    if (!hours && template.type && template.complexity && defaultHours[template.type] && defaultHours[template.type][template.complexity]) {
                        hours = defaultHours[template.type][template.complexity];
                    }

                    templates.push({
                        name: template.name,
                        type: template.type,
                        complexity: template.complexity,
                        description: template.description,
                        hoursPerUnit: hours || 0,
                        deviceCount: template.quantity,
                        pointCount: 0, // Custom templates don't have actual points
                        totalHours: (hours || 0) * template.quantity,
                        devices: ['Custom Item'], // No actual devices
                        system: 'Niagara',
                        isCustom: true
                    });
                }
            });

            // Collect Johnson templates (when implemented)
            Object.entries(johnsonData.settings).forEach(([templateIndex, settings]) => {
                if (settings.name && (settings.hours > 0 || (settings.type && settings.complexity))) {
                    const template = johnsonData.templates.exact[templateIndex];
                    if (template) {
                        const quantity = settings.customQuantity || template.devices.length;
                        let hours = settings.hours;

                        if (!hours && settings.type && settings.complexity && defaultHours[settings.type] && defaultHours[settings.type][settings.complexity]) {
                            hours = defaultHours[settings.type][settings.complexity];
                        }

                        templates.push({
                            name: settings.name,
                            type: settings.type,
                            complexity: settings.complexity,
                            description: settings.description,
                            hoursPerUnit: hours || 0,
                            deviceCount: quantity,
                            pointCount: template.points.length,
                            totalHours: (hours || 0) * quantity,
                            devices: template.devices.map(d => useJohnsonDisplayNames ? getJohnsonDisplayName(d) : d.name),
                            system: 'Johnson'
                        });
                    }
                }
            });

            // Collect Johnson custom templates
            johnsonData.customTemplates.forEach(template => {
                if (template.name && (template.hours > 0 || (template.type && template.complexity))) {
                    let hours = template.hours;

                    // If no manual hours but type/complexity set, use defaults
                    if (!hours && template.type && template.complexity && defaultHours[template.type] && defaultHours[template.type][template.complexity]) {
                        hours = defaultHours[template.type][template.complexity];
                    }

                    templates.push({
                        name: template.name,
                        type: template.type,
                        complexity: template.complexity,
                        description: template.description,
                        hoursPerUnit: hours || 0,
                        deviceCount: template.quantity,
                        pointCount: 0, // Custom templates don't have actual points
                        totalHours: (hours || 0) * template.quantity,
                        devices: ['Custom Item'], // No actual devices
                        system: 'Johnson',
                        isCustom: true
                    });
                }
            });

            const baseTotalHours = templates.reduce((sum, t) => sum + t.totalHours, 0);
            const hoursData = calculateTotalHours();

            return {
                templates: templates,
                totalEquipment: templates.reduce((sum, t) => sum + t.deviceCount, 0),
                totalPoints: templates.reduce((sum, t) => sum + (t.deviceCount * t.pointCount), 0),
                totalHours: hoursData.total,
                baseHours: hoursData.base,
                overheadHours: hoursData.overhead,
                overheadPercentage: hoursData.percentage
            };
        }

        function generateScopeOfWork() {
            const templates = [];

            // Collect Niagara templates (excluding hours and complexity)
            Object.entries(niagaraData.settings).forEach(([templateIndex, settings]) => {
                if (settings.name) {
                    const template = niagaraData.templates.exact[templateIndex];
                    if (template) {
                        const quantity = settings.customQuantity || template.devices.length;

                        templates.push({
                            name: settings.name,
                            type: settings.type || 'Equipment Template',
                            description: settings.description,
                            deviceCount: quantity,
                            pointCount: template.points.length,
                            devices: template.devices.map(d => d.name),
                            system: 'Niagara'
                        });
                    }
                }
            });

            // Collect Niagara custom templates (excluding hours and complexity)
            niagaraData.customTemplates.forEach(template => {
                if (template.name) {
                    templates.push({
                        name: template.name,
                        type: template.type || 'Custom Equipment',
                        description: template.description,
                        deviceCount: template.quantity,
                        pointCount: 0,
                        devices: ['Custom Item'],
                        system: 'Niagara',
                        isCustom: true
                    });
                }
            });

            // Collect Johnson templates (excluding hours and complexity)
            Object.entries(johnsonData.settings).forEach(([templateIndex, settings]) => {
                if (settings.name) {
                    const template = johnsonData.templates.exact[templateIndex];
                    if (template) {
                        const quantity = settings.customQuantity || template.devices.length;

                        templates.push({
                            name: settings.name,
                            type: settings.type || 'Equipment Template',
                            description: settings.description,
                            deviceCount: quantity,
                            pointCount: template.points.length,
                            devices: template.devices.map(d => useJohnsonDisplayNames ? getJohnsonDisplayName(d) : d.name),
                            system: 'Johnson'
                        });
                    }
                }
            });

            // Collect Johnson custom templates (excluding hours and complexity)
            johnsonData.customTemplates.forEach(template => {
                if (template.name) {
                    templates.push({
                        name: template.name,
                        type: template.type || 'Custom Equipment',
                        description: template.description,
                        deviceCount: template.quantity,
                        pointCount: 0,
                        devices: ['Custom Item'],
                        system: 'Johnson',
                        isCustom: true
                    });
                }
            });

            return {
                templates: templates,
                totalTemplates: templates.length,
                totalDevices: templates.reduce((sum, t) => sum + t.deviceCount, 0),
                totalPoints: templates.reduce((sum, t) => sum + (t.deviceCount * t.pointCount), 0)
            };
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // PDF Generation Helper - DEPRECATED: Now using HTML output instead
        // async function generatePDF(htmlContent, filename) {
        //     // This function has been replaced with HTML output in new tabs
        //     // Users can print/save as PDF using browser's print function
        // }

        // Custom Template Functions
        function toggleCustomTemplateForm() {
            const form = document.getElementById('customTemplateForm');
            const button = event.target;

            if (form.classList.contains('show')) {
                form.classList.remove('show');
                button.textContent = '+ Add Custom Template';
            } else {
                form.classList.add('show');
                button.textContent = 'Cancel';
                // Clear form
                clearCustomTemplateForm();
            }
        }

        function clearCustomTemplateForm() {
            document.getElementById('customTemplateName').value = '';
            document.getElementById('customTemplateType').value = '';
            document.getElementById('customTemplateQuantity').value = '1';
            document.getElementById('customTemplateHours').value = '';
            document.getElementById('customTemplateDescription').value = '';
        }

        function createCustomTemplate() {
            const name = document.getElementById('customTemplateName').value.trim();
            const typeComplexity = document.getElementById('customTemplateType').value;
            const quantity = parseInt(document.getElementById('customTemplateQuantity').value) || 1;
            const hours = parseFloat(document.getElementById('customTemplateHours').value) || 0;
            const description = document.getElementById('customTemplateDescription').value.trim();

            if (!name) {
                showToast('Template name is required', 'error');
                return;
            }

            let type = '';
            let complexity = '';
            if (typeComplexity) {
                [type, complexity] = typeComplexity.split('|');
            }

            // Auto-fill hours from defaults if type/complexity set but no manual hours
            let finalHours = hours;
            if (!hours && type && complexity && defaultHours[type] && defaultHours[type][complexity]) {
                finalHours = defaultHours[type][complexity];
            }

            const customTemplate = {
                id: Date.now(), // Simple ID for custom templates
                name: name,
                type: type,
                complexity: complexity,
                quantity: quantity,
                hours: finalHours,
                description: description,
                isCustom: true,
                devices: [], // No actual devices for custom templates
                points: [] // No actual points for custom templates
            };

            // Add to current system's custom templates
            const data = currentSystem === 'niagara' ? niagaraData : johnsonData;
            data.customTemplates.push(customTemplate);

            // Update display
            updateDisplay();
            saveToLocalStorage(); // Auto-save after creating custom template

            // Hide form and show success
            toggleCustomTemplateForm();
            showToast('Custom template created successfully');
        }

        function deleteCustomTemplate(system, templateId) {
            if (!confirm('Are you sure you want to delete this custom template?')) {
                return;
            }

            const data = system === 'niagara' ? niagaraData : johnsonData;
            data.customTemplates = data.customTemplates.filter(t => t.id !== templateId);

            updateDisplay();
            saveToLocalStorage(); // Auto-save after deleting custom template
            showToast('Custom template deleted');
        }

        function updateCustomTemplate(system, templateId, field, value) {
            const data = system === 'niagara' ? niagaraData : johnsonData;
            const template = data.customTemplates.find(t => t.id === templateId);

            if (!template) return;

            if (field === 'typeComplexity') {
                if (value) {
                    const [type, complexity] = value.split('|');
                    template.type = type;
                    template.complexity = complexity;

                    // Auto-fill hours if not manually set
                    if (!template.hours && defaultHours[type] && defaultHours[type][complexity]) {
                        template.hours = defaultHours[type][complexity];
                        // Update the hours input
                        const hoursInput = document.querySelector(`input[data-custom-id="${templateId}"][data-field="hours"]`);
                        if (hoursInput) {
                            hoursInput.value = template.hours;
                        }
                    }
                } else {
                    template.type = '';
                    template.complexity = '';
                }
            } else if (field === 'quantity') {
                template.quantity = parseInt(value) || 1;
            } else if (field === 'hours') {
                template.hours = parseFloat(value) || 0;
            } else {
                template[field] = value;
            }

            updateStats();
            updateExportButton();
            saveToLocalStorage(); // Auto-save after template change
        }

        function generateCustomTemplateCard(system, template) {
            const totalHours = template.hours * template.quantity;

            return `
                <div class="custom-template-card">
                    <div class="custom-template-badge">Custom</div>
                    <button class="custom-template-delete" onclick="deleteCustomTemplate('${system}', ${template.id})" title="Delete custom template">×</button>

                    <div class="template-header">
                        <span class="template-title">${template.name}</span>
                        <span class="template-count">${template.quantity} units</span>
                    </div>

                    <div class="template-controls">
                        <div class="template-control-group">
                            <label class="template-control-label">Template Name</label>
                            <input type="text" class="template-name-input"
                                   value="${template.name}"
                                   onchange="updateCustomTemplate('${system}', ${template.id}, 'name', this.value)">
                        </div>

                        <div class="template-control-group">
                            <label class="template-control-label">Type</label>
                            <select class="template-type-select"
                                    onchange="updateCustomTemplate('${system}', ${template.id}, 'typeComplexity', this.value)">
                                <option value="">Select Type</option>
                                ${templateTypes.map(type =>
                                    complexityLevels.map(complexity =>
                                        `<option value="${type}|${complexity}" ${template.type === type && template.complexity === complexity ? 'selected' : ''}>
                                            ${type} - ${complexity}
                                        </option>`
                                    ).join('')
                                ).join('')}
                            </select>
                        </div>

                        <div class="template-control-group">
                            <label class="template-control-label">Hours</label>
                            <input type="number" class="template-hours-input"
                                   placeholder="0.0" step="0.5" min="0"
                                   value="${template.hours || ''}"
                                   data-custom-id="${template.id}" data-field="hours"
                                   onchange="updateCustomTemplate('${system}', ${template.id}, 'hours', this.value)">
                        </div>

                        <div class="template-control-group">
                            <label class="template-control-label">Quantity</label>
                            <input type="number" class="template-hours-input"
                                   placeholder="1" min="1"
                                   value="${template.quantity}"
                                   onchange="updateCustomTemplate('${system}', ${template.id}, 'quantity', this.value)">
                        </div>

                        <div class="template-description">
                            <label class="template-control-label">Description (Optional)</label>
                            <textarea placeholder="Enter template description..."
                                      onchange="updateCustomTemplate('${system}', ${template.id}, 'description', this.value)">${template.description || ''}</textarea>
                        </div>
                    </div>

                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e9ecef; font-size: 12px; color: #6c757d;">
                        <strong>Total Hours:</strong> ${totalHours.toFixed(1)} (${template.hours} × ${template.quantity})
                    </div>
                </div>
            `;
        }

        // Change Order Functions
        let currentChangeOrderSystem = 'niagara';

        function updateChangeOrderTab() {
            // This function will be called when the change order tab is shown
            // For now, the UI is static HTML in the tab content
        }

        function selectChangeOrderSystem(system) {
            currentChangeOrderSystem = system;

            // Update button states
            document.querySelectorAll('.system-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(system + 'SystemBtn').classList.add('active');

            // Update section visibility
            document.querySelectorAll('.change-order-system-section').forEach(section => section.classList.remove('active'));
            document.getElementById(system + 'ChangeOrderSection').classList.add('active');
        }

        // Niagara Change Order Functions
        function openOriginalNiagaraFile() {
            document.getElementById('originalNiagaraFileInput').click();
        }

        function openUpdatedNiagaraFile() {
            document.getElementById('updatedNiagaraFileInput').click();
        }

        async function loadOriginalNiagaraFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const csvContent = await loadCSV(file);
                const originalData = processNiagaraCSV(csvContent);

                // Store original data
                changeOrderData.niagara.originalData = originalData;

                // Update UI
                document.getElementById('originalNiagaraFileName').textContent = file.name;
                document.getElementById('originalNiagaraFileStats').textContent =
                    `${originalData.devices.length} devices, ${originalData.templates.exact.length} templates`;
                document.getElementById('originalNiagaraFileStatus').style.display = 'block';

                // Auto-fill project name from original file
                updateProjectName(file.name);

                // Enable updated file upload
                document.getElementById('updatedNiagaraUploadBtn').disabled = false;

                showToast('Original Niagara CSV loaded successfully');
            } catch (error) {
                console.error('Error loading original Niagara file:', error);
                showToast('Error loading original Niagara file', 'error');
            }
        }

        async function loadUpdatedNiagaraFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const csvContent = await loadCSV(file);
                const updatedData = processNiagaraCSV(csvContent);

                // Store updated data
                changeOrderData.niagara.updatedData = updatedData;

                // Update UI
                document.getElementById('updatedNiagaraFileName').textContent = file.name;
                document.getElementById('updatedNiagaraFileStats').textContent =
                    `${updatedData.devices.length} devices, ${updatedData.templates.exact.length} templates`;
                document.getElementById('updatedNiagaraFileStatus').style.display = 'block';

                // Perform comparison
                performNiagaraComparison();

                showToast('Updated Niagara CSV loaded successfully');
            } catch (error) {
                console.error('Error loading updated Niagara file:', error);
                showToast('Error loading updated Niagara file', 'error');
            }
        }

        function performNiagaraComparison() {
            const data = changeOrderData.niagara;

            if (!data.originalData || !data.updatedData) {
                return;
            }

            // Compare equipment by path
            const originalPaths = new Set(data.originalData.devices.map(d => d.path));
            data.newEquipment = data.updatedData.devices.filter(d => !originalPaths.has(d.path));

            // Find existing equipment with new points
            data.modifiedEquipment = [];
            const originalEquipmentMap = new Map(data.originalData.devices.map(d => [d.path, d]));

            data.updatedData.devices.forEach(updatedDevice => {
                if (originalPaths.has(updatedDevice.path)) {
                    const originalDevice = originalEquipmentMap.get(updatedDevice.path);
                    const originalPointPaths = new Set(originalDevice.points.map(p => p.path));
                    const newPoints = updatedDevice.points.filter(p => !originalPointPaths.has(p.path));

                    if (newPoints.length > 0) {
                        data.modifiedEquipment.push({
                            name: updatedDevice.name,
                            path: updatedDevice.path,
                            points: newPoints,
                            hasPointsFolder: updatedDevice.hasPointsFolder,
                            originalPointCount: originalDevice.points.length,
                            newPointCount: newPoints.length,
                            totalPointCount: updatedDevice.points.length
                        });
                    }
                }
            });

            // Generate templates from new equipment and modified equipment
            data.newTemplates = findTemplates(data.newEquipment);
            data.modifiedTemplates = findTemplates(data.modifiedEquipment);
            data.comparisonDate = new Date();

            // Show comparison results
            displayNiagaraComparisonResults();

            // Show subsequent steps
            document.getElementById('niagaraComparisonStep').style.display = 'block';
            document.getElementById('niagaraTemplateConfigStep').style.display = 'block';
            document.getElementById('niagaraExportStep').style.display = 'block';
        }

        function displayNiagaraComparisonResults() {
            const data = changeOrderData.niagara;
            const container = document.getElementById('niagaraComparisonResults');

            const newCount = data.newEquipment.length;
            const modifiedCount = data.modifiedEquipment.length;
            const newTemplateCount = data.newTemplates.exact.length;
            const modifiedTemplateCount = data.modifiedTemplates.exact.length;
            const totalOriginal = data.originalData.devices.length;
            const totalUpdated = data.updatedData.devices.length;

            // Calculate total new points
            const newEquipmentPoints = data.newEquipment.reduce((sum, device) => sum + device.points.length, 0);
            const modifiedEquipmentPoints = data.modifiedEquipment.reduce((sum, device) => sum + device.newPointCount, 0);
            const totalNewPoints = newEquipmentPoints + modifiedEquipmentPoints;

            const html = `
                <div class="comparison-summary">
                    <h4>📊 Niagara Comparison Summary</h4>
                    <p><strong>Original:</strong> ${totalOriginal} devices</p>
                    <p><strong>Updated:</strong> ${totalUpdated} devices</p>
                    <p><strong>New Equipment:</strong> ${newCount} devices</p>
                    <p><strong>Modified Equipment:</strong> ${modifiedCount} devices (with new points)</p>
                    <p><strong>Total New Points:</strong> ${totalNewPoints} points</p>

                    <div class="comparison-stats">
                        <div class="comparison-stat">
                            <div class="comparison-stat-value">${newCount}</div>
                            <div class="comparison-stat-label">New Equipment</div>
                        </div>
                        <div class="comparison-stat">
                            <div class="comparison-stat-value">${modifiedCount}</div>
                            <div class="comparison-stat-label">Modified Equipment</div>
                        </div>
                        <div class="comparison-stat">
                            <div class="comparison-stat-value">${newTemplateCount + modifiedTemplateCount}</div>
                            <div class="comparison-stat-label">Total Templates</div>
                        </div>
                        <div class="comparison-stat">
                            <div class="comparison-stat-value">${totalNewPoints}</div>
                            <div class="comparison-stat-label">New Points</div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;

            // Update template configuration section
            displayNiagaraNewTemplates();
        }

        function displayNiagaraNewTemplates() {
            const data = changeOrderData.niagara;
            const container = document.getElementById('niagaraNewTemplatesContent');

            const totalNewTemplates = data.newTemplates.exact.length;
            const totalModifiedTemplates = data.modifiedTemplates.exact.length;

            if (totalNewTemplates === 0 && totalModifiedTemplates === 0) {
                container.innerHTML = '<p>No new equipment templates found.</p>';
                return;
            }

            let html = '';
            let templateIndex = 0;

            // Add new equipment templates
            if (totalNewTemplates > 0) {
                html += '<h5>New Equipment Templates</h5>';
                const sorted = [...data.newTemplates.exact].sort((a, b) => b.devices.length - a.devices.length);
                sorted.forEach((template, i) => {
                    const originalIndex = data.newTemplates.exact.indexOf(template);
                    const settings = data.settings[`new_${originalIndex}`] || {};
                    const percent = ((template.devices.length / data.newEquipment.length) * 100).toFixed(1);

                    html += generateNewEquipmentCard('niagara', template, `new_${originalIndex}`, settings, percent, templateIndex + 1);
                    templateIndex++;
                });
            }

            // Add modified equipment templates
            if (totalModifiedTemplates > 0) {
                html += '<h5>Modified Equipment Templates (New Points Only)</h5>';
                const sortedModified = [...data.modifiedTemplates.exact].sort((a, b) => b.devices.length - a.devices.length);
                sortedModified.forEach((template, i) => {
                    const originalIndex = data.modifiedTemplates.exact.indexOf(template);
                    const settings = data.settings[`modified_${originalIndex}`] || {};
                    const percent = ((template.devices.length / data.modifiedEquipment.length) * 100).toFixed(1);

                    html += generateNewEquipmentCard('niagara', template, `modified_${originalIndex}`, settings, percent, templateIndex + 1);
                    templateIndex++;
                });
            }

            container.innerHTML = html;
        }

        function generateNewEquipmentCard(system, template, originalIndex, settings, percent, displayIndex) {
            return `
                <div class="new-equipment-card">
                    <div class="new-equipment-badge">NEW</div>

                    <div class="template-header">
                        <span class="template-title">New Template ${displayIndex}</span>
                        <span class="template-count">${template.devices.length} devices (${percent}% of new)</span>
                    </div>

                    <div class="template-controls">
                        <div class="template-control-group">
                            <label class="template-control-label">Template Name</label>
                            <input type="text" class="template-name-input"
                                   placeholder="New Template ${displayIndex}"
                                   value="${settings.name || ''}"
                                   onchange="updateChangeOrderTemplate('${system}', ${originalIndex}, 'name', this.value)">
                        </div>

                        <div class="template-control-group">
                            <label class="template-control-label">Type</label>
                            <select class="template-type-select"
                                    onchange="updateChangeOrderTemplateType('${system}', ${originalIndex}, this.value)">
                                <option value="">Select Type</option>
                                ${templateTypes.map(type =>
                                    complexityLevels.map(complexity =>
                                        `<option value="${type}|${complexity}" ${settings.type === type && settings.complexity === complexity ? 'selected' : ''}>
                                            ${type} - ${complexity}
                                        </option>`
                                    ).join('')
                                ).join('')}
                            </select>
                        </div>

                        <div class="template-control-group">
                            <label class="template-control-label">Hours</label>
                            <input type="number" class="template-hours-input"
                                   placeholder="0.0" step="0.5" min="0"
                                   value="${settings.hours || ''}"
                                   data-template="${originalIndex}" data-field="hours"
                                   onchange="updateChangeOrderTemplate('${system}', ${originalIndex}, 'hours', this.value)">
                        </div>

                        <div class="template-control-group">
                            <label class="template-control-label">Custom Quantity</label>
                            <input type="number" class="template-hours-input"
                                   placeholder="${template.devices.length}" min="1"
                                   value="${settings.customQuantity || ''}"
                                   onchange="updateChangeOrderTemplate('${system}', ${originalIndex}, 'customQuantity', this.value)">
                        </div>

                        <div class="template-description">
                            <label class="template-control-label">Description (Optional)</label>
                            <textarea placeholder="Enter template description..."
                                      onchange="updateChangeOrderTemplate('${system}', ${originalIndex}, 'description', this.value)">${settings.description || ''}</textarea>
                        </div>
                    </div>

                    <div class="device-grid">
                        ${template.devices.map(d => `<div class="device-item" title="${d.path}">${system === 'johnson' ? getJohnsonDisplayName(d) : d.name}</div>`).join('')}
                    </div>

                    <div class="points-summary">
                        <div class="points-header">
                            <strong>${template.points.length} Points:</strong>
                        </div>
                        <div class="points-preview">
                            ${template.points.slice(0, 8).map(p => system === 'johnson' ? getJohnsonDisplayName(p) : p.name).join(', ')}
                            ${template.points.length > 8 ? '...' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function updateChangeOrderTemplate(system, index, field, value) {
            const data = changeOrderData[system];
            if (!data.settings[index]) data.settings[index] = {};

            if (field === 'customQuantity') {
                data.settings[index].customQuantity = parseInt(value) || null;
            } else if (field === 'hours') {
                data.settings[index].hours = parseFloat(value) || 0;
            } else {
                data.settings[index][field] = value;
            }
        }

        function updateChangeOrderTemplateType(system, index, value) {
            const data = changeOrderData[system];
            if (!data.settings[index]) data.settings[index] = {};

            if (value) {
                const [type, complexity] = value.split('|');
                data.settings[index].type = type;
                data.settings[index].complexity = complexity;

                // Auto-fill hours from defaults if type and complexity are set
                if (type && complexity && defaultHours[type] && defaultHours[type][complexity]) {
                    data.settings[index].hours = defaultHours[type][complexity];
                    // Update the hours input field
                    const hoursInput = document.querySelector(`input[data-template="${index}"][data-field="hours"]`);
                    if (hoursInput) {
                        hoursInput.value = defaultHours[type][complexity];
                    }
                }
            } else {
                data.settings[index].type = '';
                data.settings[index].complexity = '';
            }
        }

        function exportNiagaraChangeOrder() {
            const quote = generateNiagaraChangeOrderQuote();

            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${getProjectName()} - Niagara Change Order</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 0;
                            padding: 40px;
                            line-height: 1.4;
                            color: #333;
                            font-size: 14px;
                        }
                        .header-bar {
                            background: #0066cc;
                            color: white;
                            padding: 20px;
                            margin: -40px -40px 30px -40px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 15px;
                            min-height: 60px;
                        }
                        .logo {
                            height: 30px;
                            width: auto;
                            flex-shrink: 0;
                        }
                        .header-title {
                            font-size: 24px;
                            font-weight: bold;
                            margin: 0;
                        }
                        .header-info {
                            margin-bottom: 20px;
                            line-height: 1.5;
                            font-size: 14px;
                        }
                        .header-info p {
                            margin: 3px 0;
                        }
                        .change-order-header { background: #f39c12; color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                        .template-item { margin: 20px 0; padding: 15px; border: 1px solid #f39c12; border-radius: 8px; background: #fef9e7; }
                        .template-header { font-size: 18px; font-weight: bold; color: #e67e22; margin-bottom: 10px; }
                        .template-details { margin: 10px 0; }
                        .equipment-list { font-size: 14px; color: #666; }
                        .summary {
                            background: #e8f4fd;
                            padding: 15px;
                            border-radius: 6px;
                            margin-bottom: 20px;
                            page-break-inside: avoid;
                        }
                        .summary h3 {
                            color: #2c3e50;
                            margin-top: 0;
                            margin-bottom: 10px;
                            font-size: 16px;
                        }
                        .new-badge { background: #f39c12; color: white; padding: 3px 6px; border-radius: 3px; font-size: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .description { font-style: italic; color: #666; margin-top: 5px; }
                    </style>
                </head>
                <body>
                    <div class="header-bar">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAATIAAAByCAMAAADnN60vAAAAKlBMVEVHcEz///////////////////////////////////////////////////+LBpLMAAAADXRSTlMAQr+B2ZgQ7yBgMK9wl984bwAABjhJREFUeNrtXd1ytSoMJYHwp3n/1z2floKboqOmzpmC66ajmyhGwlpBoOrFixcvXrx48eL/AOBNzGpUGL4JrwZF4JvQSqkhG5p1fA/GKgU8os+IbyIopZCdVaPB801gimlSowH5JuA7pqMaC8B3kBqXTs1tLBi+B2dLTIMaCbNAYOSYNmog3BcYHzGt1Tggvgn4iGk3ThoQJQJDc8JQQgP5JnyO6cEYAAR9f4npkYSGlQgM+JE9jQAtSy4/YUZINb0TJZcJQwkNEiWXI443ipPLGpPqHShLLhNGEhqi0euJPzBGqilMLpvofExb8x7w9oBR32PanncRr8b0IKnmJHlqP+KHTTjgw6tRPUiqaXgP83nuGEpozLwHc0GhjCQ05I2kNNNBUk2Sd0XAPJLQ+BXCo6GEBvIeSDxy1OfH8zMx9QqNkz13uHadYYSGFumDttDoe0z7F1UoDiI0iPcwib8b9/nxPJ4QGK/QuBdMb6r5TJc99y807IHAkAqWTj+en5afb6qZ4H+/75k6FxqXGW74MW040FHSWO/04/kjw4K251TzssAYfkzbuocEATJ3+vHcwi6UCLF3ofE3iLh3WNerNjsOTLgJvwiNXoca8bD7J8EEPWU6zTOPu2nrBNNAodfRDDpeVs83EZcW3KeUVdYd5oNGMKXd90qXx/kgSBZO6F7H/4/zwUnAANb1JjAS4DAf9CxggNBbgnkuH9QSBjDd9f1f8BKhccwA0JvAOJcPBgkDUKezf6RC4yA18q4zgXHi06N0GbDuddTnWGiQZCcz08vY4jWhIWKAvy0wgBBnf/3To5ZsnIFtgeHJMLObtueD/odGtSe3LRp0BuzY5gKz/z4OpVgqsL24IZ99tN6M4nJgJ2Y0zOG60JAwQOQFuMvSaPNJ1+JVi1VR5AITm7Z1VpsqkIxTgc96uJCPC+FPbOAfHMOlVJN+ZSMIX3msNegILWK1pi6K/MO4tq3qv+8yqkTR/HEcGfX6XthcneMk326EGn2nCQCUHzT3Dq7RZSCkojrVhbTWZDKr1LbL1bXW6FIV2i5LmhMDzCaNGSwGGgDWY6UZNCtiNbG/9OkRpZvazD8EhsmOCqUJ2p9pVbpxyEVdemrIoYEt2+V8bqJhx2WlHqngrCAdp5usLmM2i+9ujGlLGMCE+vWUiKIP761HdQTjxtFx6zKff6xsl/PZqXrXZVDqEdcisBTPu+qG1WXIURHDRaFhhWuofaPjnDfNCHNsWVNpXlM3u+SyXOWpst1zmYEVZusyvXlBABDXCzrty6slzZ5JGb4zpq0lDKD2HnrTE/v1+SnHYfl1x9pCCrvKtg5M+KCD4rKqHoV32dDsUwdPqDQi04WZZmUwVR9i4n3jpsvs9iBlbQtJVdODvkVwxC/EqgchVdlmq0wQ/oLLQomO8NWMCWZkY5+Y42ROGxcvlYN0AZv/1C6D0jViFfYN28qp512m4vRJe7iGqn1kOQ3wWeNc1RILObZUHZmL/YHLmFRte0HKYqtyNpDZZsXgb6aaklG32rg8msXoU4GVzRHRfBq4pEH8EmfFZbCcmpM/f9oys8MFOqoDl1HyS8mpEnwwyeT5HXjb0A0NiKl3xtQSTHt+6LQx37os/wgt2+p52y7L9SjEHRAxZmmPj27DaM7OIS3CMxTCCfWd5w/vulgqB7WUhYbtOZflepRXM5cXZJjx2b245sM2OrVuo70Ct/o7ndGwYP6MTJOkkg2u7bKG7TmXlXqkTt+r+P0ofjkxPbvrj7NX5sNbUzt0MbWl+4rt/rXtstr2pMvqeuj6rcPDGxfThWWdtc8o6/iSQmUEl107NVw2N2xPu0xFUypR1ys8/v834NruJPqrrCNaHDojImz+aQqpAk9fJbUKa+dMiBhzSWzZVlcox6vx14mUz+sk+EF9HPMEz++Th1enyPo084+MPTNz8NFpiV4VxOpuDwqNcHeK7J//9OT5NgN0vkhiHyRhAOh3kcQTQmOVBlO3iySOECQMYN2QiySMhAHmIRdJgIQBFA608U/BJGGA2P96/Aa8iAF09+vxW9ASBlBmRAawIgaAIRkgiBiAhmQAlDCAdSMyALCEAWBIBiARA+CQDKDvwi8ypdtVvy9evHjxYjT8B5GvsSxWBvj8AAAAAElFTkSuQmCC" alt="QAG Logo" class="logo">
                        <h1 class="header-title">Niagara Change Order Quote</h1>
                    </div>

                    <div class="header-info">
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                        <p><strong>Project:</strong> ${getProjectName()}</p>
                        ${getPONumber() ? `<p><strong>PO#:</strong> ${getPONumber()}</p>` : ''}
                        <p><strong>Quote Type:</strong> Niagara Change Order - Project Additions</p>
                        <p><strong>Generated by:</strong> ${getCreatedBy()}</p>
                    </div>

                    <div class="change-order-header">
                        <h2>🔄 Niagara Change Order Summary</h2>
                        <p>This quote includes <strong>NEW NIAGARA EQUIPMENT and MODIFIED EQUIPMENT</strong> identified by comparing the original and updated CSV files.</p>
                        <p><strong>Comparison Date:</strong> ${changeOrderData.niagara.comparisonDate ? changeOrderData.niagara.comparisonDate.toLocaleString() : 'N/A'}</p>
                    </div>

                    <h2>New Equipment Templates</h2>
                    ${quote.templates.map(t => `
                        <div class="template-item">
                            <div class="template-header">
                                ${t.name} <span class="new-badge">NEW</span>
                            </div>
                            ${t.description ? `<div class="description">${t.description}</div>` : ''}
                            <div class="template-details">
                                <strong>Type:</strong> ${t.type || 'Not specified'}<br>
                                <strong>Complexity:</strong> ${t.complexity || 'Not specified'}<br>
                                <strong>Equipment Count:</strong> ${t.deviceCount} units<br>
                                <strong>Points per unit:</strong> ${t.pointCount}<br>
                                <strong>Hours per unit:</strong> ${t.hoursPerUnit}<br>
                                <strong>Total hours:</strong> ${t.totalHours}
                            </div>
                            <div class="equipment-list">
                                <strong>New Equipment:</strong> ${t.devices.join(', ')}
                            </div>
                        </div>
                    `).join('')}

                    <div class="summary">
                        <h3>Niagara Change Order Summary</h3>
                        <div><strong>Total New Equipment:</strong> ${quote.totalEquipment} units</div>
                        <div><strong>Total New Data Points:</strong> ${quote.totalPoints}</div>
                        <div><strong>Total Additional Hours:</strong> ${quote.totalHours}</div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>New Template</th>
                                <th>Type</th>
                                <th>Units</th>
                                <th>Points/Unit</th>
                                <th>Hours/Unit</th>
                                <th>Total Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${quote.templates.map(t => `
                                <tr>
                                    <td>${t.name} <span class="new-badge">NEW</span></td>
                                    <td>${(t.type && t.complexity) ? `${t.type} - ${t.complexity}` : 'Custom'}</td>
                                    <td>${t.deviceCount}</td>
                                    <td>${t.pointCount}</td>
                                    <td>${t.hoursPerUnit}</td>
                                    <td>${t.totalHours}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sanitizeFilename(getProjectName())}_Niagara_Change_Order_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Niagara Change Order quote exported successfully');
        }

        function generateNiagaraChangeOrderQuote() {
            const templates = [];

            // Collect new equipment templates
            changeOrderData.niagara.newTemplates.exact.forEach((template, index) => {
                const settingsKey = `new_${index}`;
                const settings = changeOrderData.niagara.settings[settingsKey] || {};

                if (settings.name && (settings.hours > 0 || (settings.type && settings.complexity))) {
                    const quantity = settings.customQuantity || template.devices.length;
                    let hours = settings.hours;

                    // If no manual hours but type/complexity set, use defaults
                    if (!hours && settings.type && settings.complexity && defaultHours[settings.type] && defaultHours[settings.type][settings.complexity]) {
                        hours = defaultHours[settings.type][settings.complexity];
                    }

                    templates.push({
                        name: settings.name,
                        type: settings.type,
                        complexity: settings.complexity,
                        description: settings.description,
                        hoursPerUnit: hours || 0,
                        deviceCount: quantity,
                        pointCount: template.points.length,
                        totalHours: (hours || 0) * quantity,
                        devices: template.devices.map(d => d.name),
                        system: 'Niagara',
                        isChangeOrder: true,
                        templateType: 'New Equipment'
                    });
                }
            });

            // Collect modified equipment templates
            changeOrderData.niagara.modifiedTemplates.exact.forEach((template, index) => {
                const settingsKey = `modified_${index}`;
                const settings = changeOrderData.niagara.settings[settingsKey] || {};

                if (settings.name && (settings.hours > 0 || (settings.type && settings.complexity))) {
                    const quantity = settings.customQuantity || template.devices.length;
                    let hours = settings.hours;

                    // If no manual hours but type/complexity set, use defaults
                    if (!hours && settings.type && settings.complexity && defaultHours[settings.type] && defaultHours[settings.type][settings.complexity]) {
                        hours = defaultHours[settings.type][settings.complexity];
                    }

                    templates.push({
                        name: settings.name,
                        type: settings.type,
                        complexity: settings.complexity,
                        description: settings.description,
                        hoursPerUnit: hours || 0,
                        deviceCount: quantity,
                        pointCount: template.points.length,
                        totalHours: (hours || 0) * quantity,
                        devices: template.devices.map(d => d.name),
                        system: 'Niagara',
                        isChangeOrder: true,
                        templateType: 'Modified Equipment (New Points Only)'
                    });
                }
            });

            return {
                templates: templates,
                totalEquipment: templates.reduce((sum, t) => sum + t.deviceCount, 0),
                totalPoints: templates.reduce((sum, t) => sum + (t.deviceCount * t.pointCount), 0),
                totalHours: templates.reduce((sum, t) => sum + t.totalHours, 0)
            };
        }

        // Johnson Change Order Functions
        function openOriginalJohnsonFile() {
            document.getElementById('originalJohnsonFileInput').click();
        }

        function openUpdatedJohnsonFile() {
            document.getElementById('updatedJohnsonFileInput').click();
        }

        async function loadOriginalJohnsonFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const csvContent = await loadCSV(file);
                const originalData = processJohnsonCSV(csvContent);

                // Store original data
                changeOrderData.johnson.originalData = originalData;

                // Update UI
                document.getElementById('originalJohnsonFileName').textContent = file.name;
                document.getElementById('originalJohnsonFileStats').textContent = `${originalData.devices.length} devices, ${originalData.points.size} points`;
                document.getElementById('originalJohnsonFileStatus').style.display = 'block';

                // Enable second upload button
                document.getElementById('updatedJohnsonUploadBtn').disabled = false;

                showToast('Original Johnson CSV loaded');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error loading original Johnson CSV', 'error');
            }
        }

        async function loadUpdatedJohnsonFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const csvContent = await loadCSV(file);
                const updatedData = processJohnsonCSV(csvContent);

                // Store updated data
                changeOrderData.johnson.updatedData = updatedData;

                // Update UI
                document.getElementById('updatedJohnsonFileName').textContent = file.name;
                document.getElementById('updatedJohnsonFileStats').textContent = `${updatedData.devices.length} devices, ${updatedData.points.size} points`;
                document.getElementById('updatedJohnsonFileStatus').style.display = 'block';

                // Process comparison
                processJohnsonComparison();

                showToast('Updated Johnson CSV loaded');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error loading updated Johnson CSV', 'error');
            }
        }

        function processJohnsonComparison() {
            const data = changeOrderData.johnson;
            const originalPaths = new Set(data.originalData.devices.map(d => d.path));

            // Find new equipment (in updated but not in original)
            data.newEquipment = data.updatedData.devices.filter(device =>
                !originalPaths.has(device.path)
            );

            // Find existing equipment with new points
            data.modifiedEquipment = [];
            const originalEquipmentMap = new Map(data.originalData.devices.map(d => [d.path, d]));

            data.updatedData.devices.forEach(updatedDevice => {
                if (originalPaths.has(updatedDevice.path)) {
                    const originalDevice = originalEquipmentMap.get(updatedDevice.path);
                    const originalPointPaths = new Set(originalDevice.points.map(p => p.path));
                    const newPoints = updatedDevice.points.filter(p => !originalPointPaths.has(p.path));

                    if (newPoints.length > 0) {
                        data.modifiedEquipment.push({
                            name: updatedDevice.name,
                            path: updatedDevice.path,
                            points: newPoints,
                            hasPointsFolder: updatedDevice.hasPointsFolder,
                            originalPointCount: originalDevice.points.length,
                            newPointCount: newPoints.length,
                            totalPointCount: updatedDevice.points.length
                        });
                    }
                }
            });

            // Generate templates from new equipment and modified equipment
            data.newTemplates = findTemplates(data.newEquipment);
            data.modifiedTemplates = findTemplates(data.modifiedEquipment);
            data.comparisonDate = new Date();

            // Show comparison results
            displayJohnsonComparisonResults();

            // Show subsequent steps
            document.getElementById('johnsonComparisonStep').style.display = 'block';
            document.getElementById('johnsonTemplateConfigStep').style.display = 'block';
            document.getElementById('johnsonExportStep').style.display = 'block';
        }

        function displayJohnsonComparisonResults() {
            const data = changeOrderData.johnson;
            const container = document.getElementById('johnsonComparisonResults');

            const newCount = data.newEquipment.length;
            const modifiedCount = data.modifiedEquipment.length;
            const newTemplateCount = data.newTemplates.exact.length;
            const modifiedTemplateCount = data.modifiedTemplates.exact.length;
            const totalOriginal = data.originalData.devices.length;
            const totalUpdated = data.updatedData.devices.length;

            // Calculate total new points
            const newEquipmentPoints = data.newEquipment.reduce((sum, device) => sum + device.points.length, 0);
            const modifiedEquipmentPoints = data.modifiedEquipment.reduce((sum, device) => sum + device.newPointCount, 0);
            const totalNewPoints = newEquipmentPoints + modifiedEquipmentPoints;

            const html = `
                <div class="comparison-summary">
                    <h4>📊 Johnson Comparison Summary</h4>
                    <p><strong>Original:</strong> ${totalOriginal} devices</p>
                    <p><strong>Updated:</strong> ${totalUpdated} devices</p>
                    <p><strong>New Equipment:</strong> ${newCount} devices</p>
                    <p><strong>Modified Equipment:</strong> ${modifiedCount} devices (with new points)</p>
                    <p><strong>Total New Points:</strong> ${totalNewPoints} points</p>

                    <div class="comparison-stats">
                        <div class="comparison-stat">
                            <div class="comparison-stat-value">${newCount}</div>
                            <div class="comparison-stat-label">New Equipment</div>
                        </div>
                        <div class="comparison-stat">
                            <div class="comparison-stat-value">${modifiedCount}</div>
                            <div class="comparison-stat-label">Modified Equipment</div>
                        </div>
                        <div class="comparison-stat">
                            <div class="comparison-stat-value">${newTemplateCount + modifiedTemplateCount}</div>
                            <div class="comparison-stat-label">Total Templates</div>
                        </div>
                        <div class="comparison-stat">
                            <div class="comparison-stat-value">${totalNewPoints}</div>
                            <div class="comparison-stat-label">New Points</div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;

            // Update new templates content
            updateJohnsonNewTemplatesContent();
        }

        function updateJohnsonNewTemplatesContent() {
            const container = document.getElementById('johnsonNewTemplatesContent');
            const data = changeOrderData.johnson;

            const totalNewTemplates = data.newTemplates.exact.length;
            const totalModifiedTemplates = data.modifiedTemplates.exact.length;

            if (totalNewTemplates === 0 && totalModifiedTemplates === 0) {
                container.innerHTML = '<p>No new templates detected in the Johnson comparison.</p>';
                return;
            }

            const totalEquipment = data.newEquipment.length + data.modifiedEquipment.length;
            const totalTemplates = totalNewTemplates + totalModifiedTemplates;

            let html = `
                <div class="summary-card">
                    <h2>🆕 Johnson Templates</h2>
                    <p>Configure these templates for the change order quote.</p>
                    <div class="summary-stats">
                        <div class="stat">
                            <div class="stat-value">${totalTemplates}</div>
                            <div class="stat-label">Total Templates</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${totalEquipment}</div>
                            <div class="stat-label">Total Changes</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${totalTemplates > 0 ? (totalEquipment / totalTemplates).toFixed(1) : '0'}</div>
                            <div class="stat-label">Avg per Template</div>
                        </div>
                    </div>
                </div>
            `;

            let templateIndex = 0;

            // Add new equipment templates
            if (totalNewTemplates > 0) {
                html += '<h5>New Equipment Templates</h5>';
                const sorted = [...data.newTemplates.exact].sort((a, b) => b.devices.length - a.devices.length);
                sorted.forEach((template, i) => {
                    const originalIndex = data.newTemplates.exact.indexOf(template);
                    const settings = data.settings[`new_${originalIndex}`] || {};
                    const percent = ((template.devices.length / data.newEquipment.length) * 100).toFixed(1);
                    html += generateNewTemplateCard('johnson', template, `new_${originalIndex}`, settings, percent, templateIndex + 1);
                    templateIndex++;
                });
            }

            // Add modified equipment templates
            if (totalModifiedTemplates > 0) {
                html += '<h5>Modified Equipment Templates (New Points Only)</h5>';
                const sortedModified = [...data.modifiedTemplates.exact].sort((a, b) => b.devices.length - a.devices.length);
                sortedModified.forEach((template, i) => {
                    const originalIndex = data.modifiedTemplates.exact.indexOf(template);
                    const settings = data.settings[`modified_${originalIndex}`] || {};
                    const percent = ((template.devices.length / data.modifiedEquipment.length) * 100).toFixed(1);
                    html += generateNewTemplateCard('johnson', template, `modified_${originalIndex}`, settings, percent, templateIndex + 1);
                    templateIndex++;
                });
            }

            container.innerHTML = html;
        }

        function exportJohnsonChangeOrder() {
            const quote = generateJohnsonChangeOrderQuote();
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${getProjectName()} - Johnson Change Order</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 0;
                            padding: 40px;
                            line-height: 1.4;
                            color: #333;
                            font-size: 14px;
                        }
                        .header-bar {
                            background: #0066cc;
                            color: white;
                            padding: 20px;
                            margin: -40px -40px 30px -40px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 15px;
                            min-height: 60px;
                        }
                        .logo {
                            height: 30px;
                            width: auto;
                            flex-shrink: 0;
                        }
                        .header-title {
                            font-size: 24px;
                            font-weight: bold;
                            margin: 0;
                        }
                        .header-info {
                            margin-bottom: 20px;
                            line-height: 1.5;
                            font-size: 14px;
                        }
                        .header-info p {
                            margin: 3px 0;
                        }
                        .change-order-header { background: #27ae60; color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                        .template-item { margin: 20px 0; padding: 15px; border: 1px solid #27ae60; border-radius: 8px; background: #f7fff7; }
                        .template-header { font-size: 18px; font-weight: bold; color: #27ae60; margin-bottom: 10px; }
                        .template-details { margin: 10px 0; }
                        .equipment-list { font-size: 14px; color: #666; }
                        .summary {
                            background: #e8f4fd;
                            padding: 15px;
                            border-radius: 6px;
                            margin-bottom: 20px;
                            page-break-inside: avoid;
                        }
                        .summary h3 {
                            color: #2c3e50;
                            margin-top: 0;
                            margin-bottom: 10px;
                            font-size: 16px;
                        }
                        .new-badge { background: #27ae60; color: white; padding: 3px 6px; border-radius: 3px; font-size: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background: #f7fff7; color: #27ae60; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="header-bar">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAATIAAAByCAMAAADnN60vAAAAKlBMVEVHcEz///////////////////////////////////////////////////+LBpLMAAAADXRSTlMAQr+B2ZgQ7yBgMK9wl984bwAABjhJREFUeNrtXd1ytSoMJYHwp3n/1z2floKboqOmzpmC66ajmyhGwlpBoOrFixcvXrx48eL/AOBNzGpUGL4JrwZF4JvQSqkhG5p1fA/GKgU8os+IbyIopZCdVaPB801gimlSowH5JuA7pqMaC8B3kBqXTs1tLBi+B2dLTIMaCbNAYOSYNmog3BcYHzGt1Tggvgn4iGk3ThoQJQJDc8JQQgP5JnyO6cEYAAR9f4npkYSGlQgM+JE9jQAtSy4/YUZINb0TJZcJQwkNEiWXI443ipPLGpPqHShLLhNGEhqi0euJPzBGqilMLpvofExb8x7w9oBR32PanncRr8b0IKnmJHlqP+KHTTjgw6tRPUiqaXgP83nuGEpozLwHc0GhjCQ05I2kNNNBUk2Sd0XAPJLQ+BXCo6GEBvIeSDxy1OfH8zMx9QqNkz13uHadYYSGFumDttDoe0z7F1UoDiI0iPcwib8b9/nxPJ4QGK/QuBdMb6r5TJc99y807IHAkAqWTj+en5afb6qZ4H+/75k6FxqXGW74MW040FHSWO/04/kjw4K251TzssAYfkzbuocEATJ3+vHcwi6UCLF3ofE3iLh3WNerNjsOTLgJvwiNXoca8bD7J8EEPWU6zTOPu2nrBNNAodfRDDpeVs83EZcW3KeUVdYd5oNGMKXd90qXx/kgSBZO6F7H/4/zwUnAANb1JjAS4DAf9CxggNBbgnkuH9QSBjDd9f1f8BKhccwA0JvAOJcPBgkDUKezf6RC4yA18q4zgXHi06N0GbDuddTnWGiQZCcz08vY4jWhIWKAvy0wgBBnf/3To5ZsnIFtgeHJMLObtueD/odGtSe3LRp0BuzY5gKz/z4OpVgqsL24IZ99tN6M4nJgJ2Y0zOG60JAwQOQFuMvSaPNJ1+JVi1VR5AITm7Z1VpsqkIxTgc96uJCPC+FPbOAfHMOlVJN+ZSMIX3msNegILWK1pi6K/MO4tq3qv+8yqkTR/HEcGfX6XthcneMk326EGn2nCQCUHzT3Dq7RZSCkojrVhbTWZDKr1LbL1bXW6FIV2i5LmhMDzCaNGSwGGgDWY6UZNCtiNbG/9OkRpZvazD8EhsmOCqUJ2p9pVbpxyEVdemrIoYEt2+V8bqJhx2WlHqngrCAdp5usLmM2i+9ujGlLGMCE+vWUiKIP761HdQTjxtFx6zKff6xsl/PZqXrXZVDqEdcisBTPu+qG1WXIURHDRaFhhWuofaPjnDfNCHNsWVNpXlM3u+SyXOWpst1zmYEVZusyvXlBABDXCzrty6slzZ5JGb4zpq0lDKD2HnrTE/v1+SnHYfl1x9pCCrvKtg5M+KCD4rKqHoV32dDsUwdPqDQi04WZZmUwVR9i4n3jpsvs9iBlbQtJVdODvkVwxC/EqgchVdlmq0wQ/oLLQomO8NWMCWZkY5+Y42ROGxcvlYN0AZv/1C6D0jViFfYN28qp512m4vRJe7iGqn1kOQ3wWeNc1RILObZUHZmL/YHLmFRte0HKYqtyNpDZZsXgb6aaklG32rg8msXoU4GVzRHRfBq4pEH8EmfFZbCcmpM/f9oys8MFOqoDl1HyS8mpEnwwyeT5HXjb0A0NiKl3xtQSTHt+6LQx37os/wgt2+p52y7L9SjEHRAxZmmPj27DaM7OIS3CMxTCCfWd5w/vulgqB7WUhYbtOZflepRXM5cXZJjx2b245sM2OrVuo70Ct/o7ndGwYP6MTJOkkg2u7bKG7TmXlXqkTt+r+P0ofjkxPbvrj7NX5sNbUzt0MbWl+4rt/rXtstr2pMvqeuj6rcPDGxfThWWdtc8o6/iSQmUEl107NVw2N2xPu0xFUypR1ys8/v834NruJPqrrCNaHDojImz+aQqpAk9fJbUKa+dMiBhzSWzZVlcox6vx14mUz+sk+EF9HPMEz++Th1enyPo084+MPTNz8NFpiV4VxOpuDwqNcHeK7J//9OT5NgN0vkhiHyRhAOh3kcQTQmOVBlO3iySOECQMYN2QiySMhAHmIRdJgIQBFA608U/BJGGA2P96/Aa8iAF09+vxW9ASBlBmRAawIgaAIRkgiBiAhmQAlDCAdSMyALCEAWBIBiARA+CQDKDvwi8ypdtVvy9evHjxYjT8B5GvsSxWBvj8AAAAAElFTkSuQmCC" alt="QAG Logo" class="logo">
                        <h1 class="header-title">Johnson Change Order Quote</h1>
                    </div>

                    <div class="header-info">
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                        <p><strong>Project:</strong> ${getProjectName()}</p>
                        ${getPONumber() ? `<p><strong>PO#:</strong> ${getPONumber()}</p>` : ''}
                        <p><strong>Quote Type:</strong> Johnson Change Order - Project Additions</p>
                        <p><strong>Generated by:</strong> ${getCreatedBy()}</p>
                    </div>

                    <div class="change-order-header">
                        <h2>🔄 Johnson Controls Change Order Summary</h2>
                        <p>This quote includes <strong>NEW JOHNSON EQUIPMENT and MODIFIED EQUIPMENT</strong> identified by comparing the original and updated CSV files.</p>
                        <p><strong>Comparison Date:</strong> ${changeOrderData.johnson.comparisonDate ? changeOrderData.johnson.comparisonDate.toLocaleString() : 'N/A'}</p>
                    </div>

                    ${quote.templates.map(t => `
                        <div class="template-item">
                            <div class="template-header">
                                ${t.name} <span class="new-badge">NEW</span>
                            </div>
                            ${t.description ? `<div class="description">${t.description}</div>` : ''}
                            <div class="template-details">
                                <strong>Type:</strong> ${t.type || 'Not specified'}<br>
                                <strong>Complexity:</strong> ${t.complexity || 'Not specified'}<br>
                                <strong>Equipment Count:</strong> ${t.deviceCount} units<br>
                                <strong>Points per unit:</strong> ${t.pointCount}<br>
                                <strong>Hours per unit:</strong> ${t.hoursPerUnit}<br>
                                <strong>Total hours:</strong> ${t.totalHours}
                            </div>
                            <div class="equipment-list">
                                <strong>New Equipment:</strong> ${t.devices.join(', ')}
                            </div>
                        </div>
                    `).join('')}

                    <div class="summary">
                        <h3>Johnson Change Order Summary</h3>
                        <div><strong>Total New Equipment:</strong> ${quote.totalEquipment} units</div>
                        <div><strong>Total New Data Points:</strong> ${quote.totalPoints}</div>
                        <div><strong>Total Additional Hours:</strong> ${quote.totalHours}</div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>New Template</th>
                                <th>Type</th>
                                <th>Units</th>
                                <th>Points/Unit</th>
                                <th>Hours/Unit</th>
                                <th>Total Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${quote.templates.map(t => `
                                <tr>
                                    <td>${t.name} <span class="new-badge">NEW</span></td>
                                    <td>${(t.type && t.complexity) ? `${t.type} - ${t.complexity}` : 'Custom'}</td>
                                    <td>${t.deviceCount}</td>
                                    <td>${t.pointCount}</td>
                                    <td>${t.hoursPerUnit}</td>
                                    <td>${t.totalHours}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sanitizeFilename(getProjectName())}_Johnson_Change_Order_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Johnson Change Order quote exported successfully');
        }

        function generateJohnsonChangeOrderQuote() {
            const templates = [];

            // Collect new equipment templates
            changeOrderData.johnson.newTemplates.exact.forEach((template, index) => {
                const settingsKey = `new_${index}`;
                const settings = changeOrderData.johnson.settings[settingsKey] || {};

                if (settings.name && (settings.hours > 0 || (settings.type && settings.complexity))) {
                    const quantity = settings.customQuantity || template.devices.length;
                    let hours = settings.hours;

                    // If no manual hours but type/complexity set, use defaults
                    if (!hours && settings.type && settings.complexity && defaultHours[settings.type] && defaultHours[settings.type][settings.complexity]) {
                        hours = defaultHours[settings.type][settings.complexity];
                    }

                    templates.push({
                        name: settings.name,
                        type: settings.type,
                        complexity: settings.complexity,
                        description: settings.description,
                        hoursPerUnit: hours || 0,
                        deviceCount: quantity,
                        pointCount: template.points.length,
                        totalHours: (hours || 0) * quantity,
                        devices: template.devices.map(d => useJohnsonDisplayNames ? getJohnsonDisplayName(d) : d.name),
                        points: template.points.map(p => useJohnsonDisplayNames ? getJohnsonDisplayName(p) : p.name),
                        system: 'Johnson',
                        templateType: 'New Equipment'
                    });
                }
            });

            // Collect modified equipment templates
            changeOrderData.johnson.modifiedTemplates.exact.forEach((template, index) => {
                const settingsKey = `modified_${index}`;
                const settings = changeOrderData.johnson.settings[settingsKey] || {};

                if (settings.name && (settings.hours > 0 || (settings.type && settings.complexity))) {
                    const quantity = settings.customQuantity || template.devices.length;
                    let hours = settings.hours;

                    // If no manual hours but type/complexity set, use defaults
                    if (!hours && settings.type && settings.complexity && defaultHours[settings.type] && defaultHours[settings.type][settings.complexity]) {
                        hours = defaultHours[settings.type][settings.complexity];
                    }

                    templates.push({
                        name: settings.name,
                        type: settings.type,
                        complexity: settings.complexity,
                        description: settings.description,
                        hoursPerUnit: hours || 0,
                        deviceCount: quantity,
                        pointCount: template.points.length,
                        totalHours: (hours || 0) * quantity,
                        devices: template.devices.map(d => useJohnsonDisplayNames ? getJohnsonDisplayName(d) : d.name),
                        points: template.points.map(p => useJohnsonDisplayNames ? getJohnsonDisplayName(p) : p.name),
                        system: 'Johnson',
                        templateType: 'Modified Equipment (New Points Only)'
                    });
                }
            });

            return {
                templates: templates,
                totalEquipment: templates.reduce((sum, t) => sum + t.deviceCount, 0),
                totalPoints: templates.reduce((sum, t) => sum + (t.deviceCount * t.pointCount), 0),
                totalHours: templates.reduce((sum, t) => sum + t.totalHours, 0)
            };
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeDefaultHours();

            // Try to load saved data first
            const dataLoaded = loadFromLocalStorage();

            if (dataLoaded) {
                // Update UI to reflect loaded data
                updateCurrentTabContent();
                updateStats();
                updateExportButton();
                updateConfigTab();
                updateDisplay();

                // Update the display names toggle if needed
                const displayNamesBtn = document.querySelector('.display-names-btn');
                if (displayNamesBtn && useJohnsonDisplayNames) {
                    displayNamesBtn.classList.add('active');
                }

                // Set the correct tab active
                const tabs = document.querySelectorAll('.tab-btn');
                tabs.forEach(tab => tab.classList.remove('active'));
                const activeTab = document.querySelector(`[onclick*="${currentTab}"]`);
                if (activeTab) activeTab.classList.add('active');

                // Show the correct tab content
                const tabContents = document.querySelectorAll('.tab-content');
                tabContents.forEach(content => content.classList.remove('active'));
                const activeContent = document.getElementById(currentTab + 'Tab');
                if (activeContent) activeContent.classList.add('active');
            } else {
                // No saved data, use default initialization
                updateConfigTab();
                updateDisplay();
            }
        });

        console.log('Quote Tool - BAS Project Estimator initialized');
    </script>
</body>
</html>
